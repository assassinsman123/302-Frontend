<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>Reminders & Notifications</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!--Navbar-->
    <nav class="navbar">
        <div class="nav-left">
            <h2>üîî Reminders & Notifications</h2>
        </div>
        
        <div class="nav-right">
            <!-- User Icon - Logout -->
            <div class="user-icon-container">
                <span class="user-icon" onclick="toggleLogout()" title="Click to show logout option">üë§</span>
                <span class="logout-text" id="logoutText" onclick="logout()" style="display: none;">Logout</span>
            </div>
        </div>
    </nav>

    <!--Reminder Container-->
    <div class="reminder-container">
        <div class="reminder-header">
            <h1>üìã Booking Alert & Reservation Center</h1>
            <p style="color: #666; margin-bottom: 30px;">
                üîî Set up alerts to get notified when someone books items for pickup<br>
                üìß Automatic email notifications with pickup dates, times, and locations
            </p>
        </div>

        <!-- Booking Form Section -->
        <div class="booking-form-section" id="bookingSection">
            <h2>üìÖ Schedule Pickup & Enable Alerts</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                Set up booking alerts and schedule pickup for your selected item
            </p>
            
            <form id="pickupBookingForm" class="booking-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="userEmail">üìß Email Address *</label>
                        <input type="email" id="userEmail" name="userEmail" required 
                               placeholder="your.email@example.com"
                               title="Enter your email for booking alerts and confirmations">
                        <small>We'll send pickup alerts and confirmations to this email</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="selectedItem">üì¶ Item</label>
                        <select id="selectedItem" name="selectedItem" required>
                            <option value="">Select an item...</option>
                            <!-- Items will be populated dynamically -->
                        </select>
                        <small>Choose the item you want alerts for</small>
                    </div>
                </div>
                
                <div class="alert-actions" style="margin: 20px 0; padding: 15px; background: #f0f8ff; border-radius: 8px; border-left: 4px solid #007BFF;">
                    <h4 style="margin: 0 0 10px 0; color: #007BFF;">üîî Booking Alert Options</h4>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button type="button" onclick="enableAlertsOnly()" class="btn-secondary">
                            üîî Enable Alerts Only
                        </button>
                        <button type="button" onclick="showFullBookingForm()" class="btn-primary">
                            üìÖ Schedule Pickup + Alerts
                        </button>
                    </div>
                    <small style="color: #666; margin-top: 10px; display: block;">
                        Choose "Alerts Only" to get notified when others book this item, or "Schedule Pickup" to book it yourself.
                    </small>
                </div>
                
                <div id="fullBookingFields" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pickupDate">üìÖ Pickup Date *</label>
                            <input type="date" id="pickupDate" name="pickupDate"
                                   title="Select your preferred pickup date">
                            <small>Choose any date from today onwards</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="pickupTime">‚è∞ Pickup Time *</label>
                            <select id="pickupTime" name="pickupTime">
                                <option value="">Select time...</option>
                                <option value="09:00">9:00 AM</option>
                                <option value="10:00">10:00 AM</option>
                                <option value="11:00">11:00 AM</option>
                                <option value="12:00">12:00 PM</option>
                                <option value="13:00">1:00 PM</option>
                                <option value="14:00">2:00 PM</option>
                                <option value="15:00">3:00 PM</option>
                                <option value="16:00">4:00 PM</option>
                                <option value="17:00">5:00 PM</option>
                                <option value="18:00">6:00 PM</option>
                                <option value="19:00">7:00 PM</option>
                            </select>
                            <small>Available pickup hours: 9:00 AM - 7:00 PM</small>
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="pickupLocation">üìç Pickup Location *</label>
                        <select id="pickupLocation" name="pickupLocation">
                            <option value="">Select pickup location...</option>
                            <option value="campus-main">Main Campus - Student Center</option>
                            <option value="campus-library">Campus Library - Front Entrance</option>
                            <option value="campus-parking">Main Parking Lot - Near Entrance</option>
                            <option value="downtown-cafe">Downtown Cafe - Central Square</option>
                            <option value="mall-entrance">Shopping Mall - Main Entrance</option>
                            <option value="park-meetup">City Park - Main Pavilion</option>
                            <option value="other">Other Location (specify in notes)</option>
                        </select>
                        <small>Choose a safe, public meeting location</small>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="pickupNotes">üìù Additional Notes (Optional)</label>
                        <textarea id="pickupNotes" name="pickupNotes" rows="3" 
                                  placeholder="Any special instructions, alternative location details, or specific meetup information..."></textarea>
                        <small>Include any special instructions or location details</small>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" onclick="clearBookingForm()" class="btn-secondary">üóëÔ∏è Clear</button>
                    <button type="button" onclick="goBackToItem()" class="btn-secondary">‚Üê Back to Item</button>
                    <button type="submit" class="btn-primary" id="submitBtn">üîî Enable Alerts</button>
                </div>
            </form>
        </div>

        <!-- Booking Alert Status -->
        <div class="booking-alert-status" id="alertStatus">
            <h2>üì® Your Booking Alerts</h2>
            <div id="alertStatusContent">
                <div class="no-alerts" id="noAlerts">
                    <span class="no-alerts-icon">üîî</span>
                    <p>No booking alerts set up yet</p>
                    <small>Use the form above to enable alerts for items you're interested in</small>
                </div>
            </div>
            
            <div class="recent-bookings">
                <h3>üìÖ Recent Bookings (Last 24 Hours)</h3>
                <div id="recentBookings">
                    <div class="no-bookings" id="noBookings">
                        <span class="no-bookings-icon">üì¶</span>
                        <p>No recent bookings</p>
                        <small>When someone books an item you're watching, it will appear here</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Settings -->
        <div class="notification-settings-section">
            <h2>‚öôÔ∏è Notification Settings</h2>
            
            <div class="setting-item">
                <div class="setting-info">
                    <strong>üì± Push Notifications</strong>
                    <p>Get instant alerts when sellers respond to your messages</p>
                </div>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="pushNotifications" onchange="togglePushNotifications()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-info">
                    <strong>üìß Email Notifications</strong>
                    <p>Receive email updates about your bookings and messages</p>
                </div>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="emailNotifications" onchange="toggleEmailNotifications()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-info">
                    <strong>‚è∞ Pickup Reminders</strong>
                    <p>Get reminded 1 hour before your scheduled pickup time</p>
                </div>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="pickupReminders" onchange="togglePickupReminders()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-info">
                    <strong>üí∞ Price Drop Alerts</strong>
                    <p>Notify when items in your wishlist drop in price</p>
                </div>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="priceAlerts" onchange="togglePriceAlerts()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Active Reminders -->
        <div class="active-reminders-section">
            <h2>üîî Active Reminders</h2>
            <div id="activeReminders" class="reminders-list">
                <!-- Reminders will be populated here -->
                <div class="no-reminders" id="noReminders">
                    <span class="no-reminders-icon">üì≠</span>
                    <p>No active reminders yet</p>
                    <small>Enable notifications for items you're interested in to see reminders here</small>
                </div>
            </div>
        </div>

        <!-- Recent Notifications -->
        <div class="recent-notifications-section">
            <h2>üì® Recent Notifications</h2>
            <div id="recentNotifications" class="notifications-list">
                <!-- Recent notifications will be populated here -->
                <div class="no-notifications" id="noNotifications">
                    <span class="no-notifications-icon">üì™</span>
                    <p>No recent notifications</p>
                    <small>Your notification history will appear here</small>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button type="button" onclick="clearAllNotifications()" class="btn-secondary">üóëÔ∏è Clear All</button>
            <button type="button" onclick="testNotifications()" class="btn-primary">üîî Test Notifications</button>
            <button type="button" onclick="window.location.href='{{ url_for('products') }}'" class="btn-primary">‚Üê Back to Products</button>
        </div>
    </div>

    <!-- Pop-up Notification -->
    <div id="notification-popup" class="notification-popup">
        <div class="notification-content">
            <span class="notification-icon" id="notificationEmoji">üîî</span>
            <span class="notification-text">Notification settings updated!</span>
            <span class="close-notification" onclick="closeNotification()">‚úï</span>
        </div>
    </div>

    <script>
        // Notification settings state
        let notificationSettings = {
            push: false,
            email: false,
            pickup: false,
            price: false
        };

        // Active reminders array
        let activeReminders = [];

        // Recent notifications array
        let recentNotifications = [];

        function toggleLogout() {
            const logoutText = document.getElementById('logoutText');
            const isVisible = logoutText.style.display !== 'none';
            
            if (isVisible) {
                logoutText.style.display = 'none';
            } else {
                logoutText.style.display = 'inline-block';
            }
        }
        
        function logout() {
            window.location.href = "{{ url_for('logout') }}";
        }

        function togglePushNotifications() {
            const checkbox = document.getElementById('pushNotifications');
            notificationSettings.push = checkbox.checked;
            
            if (checkbox.checked) {
                showNotification('üì± Push notifications enabled!', 'üîî');
                addRecentNotification('Push notifications enabled', 'Settings');
            } else {
                showNotification('üì± Push notifications disabled!', 'üîï');
                addRecentNotification('Push notifications disabled', 'Settings');
            }
            
            saveSettings();
        }

        function toggleEmailNotifications() {
            const checkbox = document.getElementById('emailNotifications');
            notificationSettings.email = checkbox.checked;
            
            if (checkbox.checked) {
                showNotification('üìß Email notifications enabled!', 'üìß');
                addRecentNotification('Email notifications enabled', 'Settings');
            } else {
                showNotification('üìß Email notifications disabled!', 'üì™');
                addRecentNotification('Email notifications disabled', 'Settings');
            }
            
            saveSettings();
        }

        function togglePickupReminders() {
            const checkbox = document.getElementById('pickupReminders');
            notificationSettings.pickup = checkbox.checked;
            
            if (checkbox.checked) {
                showNotification('‚è∞ Pickup reminders enabled!', '‚è∞');
                addRecentNotification('Pickup reminders enabled', 'Settings');
            } else {
                showNotification('‚è∞ Pickup reminders disabled!', '‚è∞');
                addRecentNotification('Pickup reminders disabled', 'Settings');
            }
            
            saveSettings();
        }

        function togglePriceAlerts() {
            const checkbox = document.getElementById('priceAlerts');
            notificationSettings.price = checkbox.checked;
            
            if (checkbox.checked) {
                showNotification('üí∞ Price drop alerts enabled!', 'üí∞');
                addRecentNotification('Price drop alerts enabled', 'Settings');
            } else {
                showNotification('üí∞ Price drop alerts disabled!', 'üí∏');
                addRecentNotification('Price drop alerts disabled', 'Settings');
            }
            
            saveSettings();
        }

        function addRecentNotification(message, type) {
            const timestamp = new Date().toLocaleTimeString();
            const notification = {
                message: message,
                type: type,
                timestamp: timestamp,
                id: Date.now()
            };
            
            recentNotifications.unshift(notification);
            
            // Keep only last 10 notifications
            if (recentNotifications.length > 10) {
                recentNotifications = recentNotifications.slice(0, 10);
            }
            
            updateRecentNotificationsDisplay();
            saveNotifications();
        }

        function updateRecentNotificationsDisplay() {
            const container = document.getElementById('recentNotifications');
            const noNotifications = document.getElementById('noNotifications');
            
            if (recentNotifications.length === 0) {
                noNotifications.style.display = 'block';
                return;
            }
            
            noNotifications.style.display = 'none';
            
            // Clear existing notifications (except the no-notifications div)
            const existingItems = container.querySelectorAll('.notification-item');
            existingItems.forEach(item => item.remove());
            
            // Add new notifications
            recentNotifications.forEach(notification => {
                const notificationDiv = document.createElement('div');
                notificationDiv.className = 'notification-item';
                notificationDiv.innerHTML = `
                    <div class="notification-header">
                        <span class="notification-type">${notification.type}</span>
                        <span class="notification-time">${notification.timestamp}</span>
                    </div>
                    <div class="notification-message">${notification.message}</div>
                    <button class="remove-notification" onclick="removeNotification(${notification.id})">‚úï</button>
                `;
                container.appendChild(notificationDiv);
            });
        }

        function removeNotification(id) {
            recentNotifications = recentNotifications.filter(n => n.id !== id);
            updateRecentNotificationsDisplay();
            saveNotifications();
        }

        function clearAllNotifications() {
            if (confirm('Are you sure you want to clear all notifications?')) {
                recentNotifications = [];
                activeReminders = [];
                updateRecentNotificationsDisplay();
                updateActiveRemindersDisplay();
                saveNotifications();
                showNotification('All notifications cleared!', 'üóëÔ∏è');
            }
        }

        function testNotifications() {
            showNotification('üéâ Test notification successful!', '‚úÖ');
            addRecentNotification('Test notification sent', 'System');
        }

        function updateActiveRemindersDisplay() {
            const container = document.getElementById('activeReminders');
            const noReminders = document.getElementById('noReminders');
            
            if (activeReminders.length === 0) {
                noReminders.style.display = 'block';
                return;
            }
            
            noReminders.style.display = 'none';
            
            // Clear existing reminders (except the no-reminders div)
            const existingItems = container.querySelectorAll('.reminder-item');
            existingItems.forEach(item => item.remove());
            
            // Add new reminders
            activeReminders.forEach(reminder => {
                const reminderDiv = document.createElement('div');
                reminderDiv.className = 'reminder-item';
                reminderDiv.innerHTML = `
                    <div class="reminder-header">
                        <span class="reminder-type">${reminder.type}</span>
                        <span class="reminder-time">${reminder.time}</span>
                    </div>
                    <div class="reminder-message">${reminder.message}</div>
                    <button class="remove-reminder" onclick="removeReminder(${reminder.id})">‚úï</button>
                `;
                container.appendChild(reminderDiv);
            });
        }

        function removeReminder(id) {
            activeReminders = activeReminders.filter(r => r.id !== id);
            updateActiveRemindersDisplay();
            saveNotifications();
        }

        function showNotification(message, emoji = 'üîî') {
            const popup = document.getElementById('notification-popup');
            const notificationText = document.querySelector('.notification-text');
            const notificationEmoji = document.getElementById('notificationEmoji');
            const notificationContent = document.querySelector('.notification-content');
            
            notificationText.textContent = message;
            notificationEmoji.textContent = emoji;
            
            // Set color based on action
            if (message.includes('disabled') || message.includes('cleared')) {
                notificationContent.style.background = '#f44336'; // Red
            } else {
                notificationContent.style.background = '#4CAF50'; // Green
            }
            
            popup.style.display = 'flex';
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                closeNotification();
            }, 3000);
        }
        
        function closeNotification() {
            const popup = document.getElementById('notification-popup');
            popup.style.display = 'none';
        }

        function saveSettings() {
            localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('notificationSettings');
            if (saved) {
                notificationSettings = JSON.parse(saved);
                
                // Update checkboxes
                document.getElementById('pushNotifications').checked = notificationSettings.push;
                document.getElementById('emailNotifications').checked = notificationSettings.email;
                document.getElementById('pickupReminders').checked = notificationSettings.pickup;
                document.getElementById('priceAlerts').checked = notificationSettings.price;
            }
        }

        function saveNotifications() {
            localStorage.setItem('recentNotifications', JSON.stringify(recentNotifications));
            localStorage.setItem('activeReminders', JSON.stringify(activeReminders));
        }

        function loadNotifications() {
            const savedNotifications = localStorage.getItem('recentNotifications');
            const savedReminders = localStorage.getItem('activeReminders');
            
            if (savedNotifications) {
                recentNotifications = JSON.parse(savedNotifications);
                updateRecentNotificationsDisplay();
            }
            
            if (savedReminders) {
                activeReminders = JSON.parse(savedReminders);
                updateActiveRemindersDisplay();
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadNotifications();
            initializeBookingForm();
            handleURLParameters();
            
            // Add some sample notifications if none exist
            if (recentNotifications.length === 0) {
                addRecentNotification('Welcome to the notification center!', 'System');
            }
        });
        
        function handleURLParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const itemId = urlParams.get('item_id');
            const itemName = urlParams.get('item_name');
            const action = urlParams.get('action');
            
            if (itemId && itemName && action === 'enable_alert') {
                // Scroll to booking section
                document.getElementById('bookingSection').scrollIntoView({ behavior: 'smooth' });
                
                // Pre-select the item
                setTimeout(() => {
                    const itemSelect = document.getElementById('selectedItem');
                    itemSelect.value = itemId;
                    
                    // Highlight the booking section
                    const bookingSection = document.getElementById('bookingSection');
                    bookingSection.style.border = '3px solid #FF6B35';
                    bookingSection.style.boxShadow = '0 0 20px rgba(255,107,53,0.3)';
                    
                    // Show a welcome message
                    showNotification(
                        `üîî Set up alerts for "${itemName}"`,
                        'üí¨'
                    );
                }, 500);
            }
        }
        
        function initializeBookingForm() {
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('pickupDate').min = today;
            
            // Load saved email if exists
            const savedEmail = localStorage.getItem('userEmail');
            if (savedEmail) {
                document.getElementById('userEmail').value = savedEmail;
            }
            
            // Populate items from available products
            populateItemSelect();
            
            // Update booking alerts display
            updateBookingAlertsDisplay();
            
            // Add form submit handler
            document.getElementById('pickupBookingForm').addEventListener('submit', handleBookingSubmit);
        }
        
        function populateItemSelect() {
            const itemSelect = document.getElementById('selectedItem');
            
            // Sample items (in real app, this would come from server)
            const sampleItems = [
                { id: '0', name: 'Smart Watch - $89' },
                { id: '1', name: 'Laptop - $59' },
                { id: '2', name: 'Pants - $120' },
                { id: '3', name: 'T-Shirts - $15' },
                { id: '4', name: 'Smart Phone - $55' },
                { id: '5', name: 'Shoes - $20' }
            ];
            
            // Clear existing options (except the first one)
            while (itemSelect.children.length > 1) {
                itemSelect.removeChild(itemSelect.lastChild);
            }
            
            // Add items
            sampleItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.name;
                itemSelect.appendChild(option);
            });
        }
        
        function enableAlertsOnly() {
            const email = document.getElementById('userEmail').value;
            const itemId = document.getElementById('selectedItem').value;
            
            if (!email || !email.includes('@')) {
                alert('Please enter a valid email address first.');
                document.getElementById('userEmail').focus();
                return;
            }
            
            if (!itemId) {
                alert('Please select an item first.');
                document.getElementById('selectedItem').focus();
                return;
            }
            
            // Save email
            localStorage.setItem('userEmail', email);
            
            // Enable alerts
            saveBookingAlert(itemId, getItemName(itemId));
            
            // Add to recent notifications
            addRecentNotification(`Alerts enabled for ${getItemName(itemId)}`, 'Alert Setup');
            
            // Show success message and redirect
            alert(`‚úÖ Booking alerts enabled!\n\nYou will receive email notifications at ${email} when someone books this item for pickup.`);
            
            // Redirect to products page
            window.location.href = '/products';
        }
        
        function showFullBookingForm() {
            const fullFields = document.getElementById('fullBookingFields');
            const submitBtn = document.getElementById('submitBtn');
            
            fullFields.style.display = 'block';
            submitBtn.innerHTML = 'üìÖ Schedule Pickup + Enable Alerts';
            
            // Make fields required
            document.getElementById('pickupDate').required = true;
            document.getElementById('pickupTime').required = true;
            document.getElementById('pickupLocation').required = true;
            
            // Scroll to show the new fields
            setTimeout(() => {
                fullFields.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }
        
        function getItemName(itemId) {
            const itemSelect = document.getElementById('selectedItem');
            const option = itemSelect.querySelector(`option[value="${itemId}"]`);
            return option ? option.textContent : 'Unknown Item';
        }
        
        function saveBookingAlert(itemId, itemName) {
            // Get existing alerts or create new array
            let bookingAlerts = JSON.parse(localStorage.getItem('bookingAlerts') || '[]');
            
            // Check if alert already exists
            const existingAlert = bookingAlerts.find(alert => alert.itemId === itemId);
            
            if (!existingAlert) {
                const alertData = {
                    itemId: itemId,
                    itemName: itemName,
                    enabled: true,
                    dateCreated: new Date().toISOString(),
                    emailSent: false
                };
                
                bookingAlerts.push(alertData);
                localStorage.setItem('bookingAlerts', JSON.stringify(bookingAlerts));
                
                // Update the display
                updateBookingAlertsDisplay();
                
                // Send to server for email notification setup
                fetch('/api/enable_booking_alert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        item_id: itemId,
                        item_name: itemName,
                        user_email: getUserEmail()
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Booking alert saved to server');
                        addRecentNotification(`üìß Email alerts enabled for ${itemName}`, 'Alert Setup');
                    }
                })
                .catch(error => {
                    console.error('Error saving booking alert:', error);
                });
            }
        }
        
        function getUserEmail() {
            return document.getElementById('userEmail').value || localStorage.getItem('userEmail') || '';
        }
        
        function handleBookingSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const email = formData.get('userEmail');
            const itemId = formData.get('selectedItem');
            const isFullBooking = document.getElementById('fullBookingFields').style.display !== 'none';
            
            // Basic validation
            if (!email || !email.includes('@')) {
                alert('‚ùå Please enter a valid email address.');
                document.getElementById('userEmail').focus();
                return;
            }
            
            if (!itemId) {
                alert('‚ùå Please select an item.');
                document.getElementById('selectedItem').focus();
                return;
            }
            
            // Save email
            localStorage.setItem('userEmail', email);
            
            if (isFullBooking) {
                // Handle full booking
                const bookingData = {
                    email: email,
                    itemId: itemId,
                    pickupDate: formData.get('pickupDate'),
                    pickupTime: formData.get('pickupTime'),
                    pickupLocation: formData.get('pickupLocation'),
                    notes: formData.get('pickupNotes') || ''
                };
                
                if (!validateBookingForm(bookingData)) {
                    return;
                }
                
                createBooking(bookingData);
            } else {
                // Just enable alerts
                enableAlertsOnly();
            }
        }
        
        function validateBookingForm(data) {
            const errors = [];
            
            if (!data.pickupDate) {
                errors.push('‚Ä¢ Please select a pickup date');
            } else {
                const selectedDate = new Date(data.pickupDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (selectedDate < today) {
                    errors.push('‚Ä¢ Pickup date cannot be in the past');
                }
            }
            
            if (!data.pickupTime) {
                errors.push('‚Ä¢ Please select a pickup time');
            }
            
            if (!data.pickupLocation) {
                errors.push('‚Ä¢ Please select a pickup location');
            }
            
            if (errors.length > 0) {
                alert(`‚ùå Please fix these errors:\n\n${errors.join('\n')}`);
                return false;
            }
            
            return true;
        }
        
        function createBooking(bookingData) {
            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚è≥ Scheduling...';
            submitBtn.disabled = true;
            
            // Simulate API call to create booking
            fetch('/api/create_reservation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    item_id: bookingData.itemId,
                    pickup_date: bookingData.pickupDate,
                    pickup_time: bookingData.pickupTime,
                    pickup_location: bookingData.pickupLocation,
                    email: bookingData.email,
                    notes: bookingData.notes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const itemName = getItemName(bookingData.itemId);
                    
                    // Add to recent notifications
                    addRecentNotification(`Pickup scheduled for ${itemName}`, 'Booking');
                    
                    // Add to recent bookings display
                    addRecentBooking({
                        itemName: itemName,
                        pickupDate: bookingData.pickupDate,
                        pickupTime: bookingData.pickupTime,
                        location: getLocationName(bookingData.pickupLocation),
                        reservationId: data.reservation_id,
                        alertsSent: data.alerts_sent || 0
                    });
                    
                    // Show success message with alert information
                    let alertMessage = `‚úÖ Pickup Scheduled Successfully!\n\n` +
                        `Item: ${itemName}\n` +
                        `Date: ${bookingData.pickupDate}\n` +
                        `Time: ${bookingData.pickupTime}\n` +
                        `Location: ${getLocationName(bookingData.pickupLocation)}\n` +
                        `Your Email: ${bookingData.email}\n` +
                        `Reservation ID: ${data.reservation_id || 'N/A'}`;
                    
                    if (data.alerts_sent && data.alerts_sent > 0) {
                        alertMessage += `\n\nüìß ALERT NOTIFICATIONS SENT!\n` +
                            `${data.alerts_sent} users with booking alerts for this item have been notified via email.`;
                    }
                    
                    alert(alertMessage);
                    
                    // Redirect to products page
                    window.location.href = '/products';
                    
                } else {
                    alert(`‚ùå Booking Failed\n\n${data.message || 'Unable to schedule pickup. Please try again.'}`);
                }
            })
            .catch(error => {
                console.error('Booking error:', error);
                alert('‚ùå Network Error\n\nUnable to connect to server. Please check your connection and try again.');
            })
            .finally(() => {
                // Restore button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        }
        
        function getLocationName(locationValue) {
            const locationMap = {
                'campus-main': 'Main Campus',
                'campus-library': 'Campus Library',
                'campus-parking': 'Main Parking Lot',
                'downtown-cafe': 'Downtown Cafe ',
                'mall-entrance': 'Shopping Mall',
                'park-meetup': 'City Park',
                'other': 'Other Location'
            };
            return locationMap[locationValue] || locationValue;
        }
        
        function clearBookingForm() {
            document.getElementById('pickupBookingForm').reset();
            document.getElementById('fullBookingFields').style.display = 'none';
            document.getElementById('submitBtn').innerHTML = 'üîî Enable Alerts';
            
            // Remove required attributes
            document.getElementById('pickupDate').required = false;
            document.getElementById('pickupTime').required = false;
            document.getElementById('pickupLocation').required = false;
            
            // Restore saved email
            const savedEmail = localStorage.getItem('userEmail');
            if (savedEmail) {
                document.getElementById('userEmail').value = savedEmail;
            }
            
            showNotification('üóëÔ∏è Form cleared', 'üìã');
        }
        
        function goBackToItem() {
            const urlParams = new URLSearchParams(window.location.search);
            const itemId = urlParams.get('item_id');
            
            if (itemId) {
                window.location.href = `/item/${itemId}/message`;
            } else {
                window.location.href = '/products';
            }
        }
        
        function updateBookingAlertsDisplay() {
            const container = document.getElementById('alertStatusContent');
            const noAlerts = document.getElementById('noAlerts');
            const bookingAlerts = JSON.parse(localStorage.getItem('bookingAlerts') || '[]');
            
            if (bookingAlerts.length === 0) {
                noAlerts.style.display = 'block';
                return;
            }
            
            noAlerts.style.display = 'none';
            
            // Clear existing alerts
            const existingItems = container.querySelectorAll('.alert-item');
            existingItems.forEach(item => item.remove());
            
            // Add current alerts
            bookingAlerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert-item';
                alertDiv.innerHTML = `
                    <div class="alert-header">
                        <span class="alert-item-name">üì¶ ${alert.itemName}</span>
                        <span class="alert-status">üîî Active</span>
                    </div>
                    <div class="alert-details">
                        <small>üìß Email alerts enabled since ${new Date(alert.dateCreated).toLocaleDateString()}</small>
                    </div>
                    <button class="remove-alert" onclick="removeBookingAlert('${alert.itemId}')">Remove Alert</button>
                `;
                container.appendChild(alertDiv);
            });
        }
        
        function removeBookingAlert(itemId) {
            if (confirm('Are you sure you want to disable booking alerts for this item?')) {
                let bookingAlerts = JSON.parse(localStorage.getItem('bookingAlerts') || '[]');
                bookingAlerts = bookingAlerts.filter(alert => alert.itemId !== itemId);
                localStorage.setItem('bookingAlerts', JSON.stringify(bookingAlerts));
                
                // Update display
                updateBookingAlertsDisplay();
                
                // Send to server to disable
                fetch('/api/disable_booking_alert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ item_id: itemId })
                })
                .catch(error => {
                    console.error('Error removing booking alert:', error);
                });
                
                showNotification('üîï Booking alert removed', '‚úÖ');
            }
        }
        
        function addRecentBooking(bookingData) {
            const container = document.getElementById('recentBookings');
            const noBookings = document.getElementById('noBookings');
            
            noBookings.style.display = 'none';
            
            const bookingDiv = document.createElement('div');
            bookingDiv.className = 'booking-item';
            bookingDiv.innerHTML = `
                <div class="booking-header">
                    <span class="booking-item-name">üìÖ ${bookingData.itemName}</span>
                    <span class="booking-time">Just booked</span>
                </div>
                <div class="booking-details">
                    <div>üìÖ Date: ${bookingData.pickupDate}</div>
                    <div>‚è∞ Time: ${bookingData.pickupTime}</div>
                    <div>üìç Location: ${bookingData.location}</div>
                    <div>üé´ ID: ${bookingData.reservationId}</div>
                    ${bookingData.alertsSent > 0 ? `<div style="color: #4CAF50;">üìß ${bookingData.alertsSent} alert emails sent</div>` : ''}
                </div>
            `;
            
            // Insert at the beginning
            const firstChild = container.firstElementChild;
            if (firstChild && firstChild !== noBookings) {
                container.insertBefore(bookingDiv, firstChild);
            } else {
                container.appendChild(bookingDiv);
            }
            
            // Keep only last 5 bookings
            const bookingItems = container.querySelectorAll('.booking-item');
            if (bookingItems.length > 5) {
                bookingItems[bookingItems.length - 1].remove();
            }
        }

        // Global function to add notifications from other pages
        window.addNotificationReminder = function(itemName, type, time) {
            const reminder = {
                message: `Reminder for ${itemName}`,
                type: type,
                time: time,
                id: Date.now()
            };
            
            activeReminders.push(reminder);
            updateActiveRemindersDisplay();
            saveNotifications();
        };
    </script>
</body>
</html>