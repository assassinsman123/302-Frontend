<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Seller Message</title>
  <link rel="stylesheet" href="../static/style.css">
</head>
<body>
    <!--Navbar-->
    <nav class="navbar">
        <div class="nav-left">
            <h2>Chat with Seller</h2>
        </div>
        
        <div class="nav-right">
            <!-- Notification Bell Icon -->
            <div class="notification-bell" onclick="toggleNotificationPanel()" title="Booking Alerts & Notifications">
                <span class="bell-icon">üîî</span>
                <span class="notification-badge" id="notificationBadge">0</span>
            </div>
            
            <!-- User Icon - Logout -->
            <div class="user-icon-container">
                <span class="user-icon" onclick="toggleLogout()" title="Click to show logout option">üë§</span>
                <span class="logout-text" id="logoutText" onclick="logout()" style="display: none;">Logout</span>
            </div>
        </div>
    </nav>

    <!--Chat Container-->
    <div class="chat-container">
        <!-- Notification Side Panel -->
        <div class="notification-panel" id="notificationPanel">
            <div class="notification-header">
                <h3>üîî Notifications & Alerts</h3>
                <button class="close-panel" onclick="toggleNotificationPanel()">‚úï</button>
            </div>
            
            <!-- Current Item Alert Status -->
            <div class="current-item-alert">
                <h4>üì¶ Current Item Alerts</h4>
                <div id="currentItemAlertStatus">
                    <div class="alert-status-card" id="alertStatusCard">
                        <div class="alert-info">
                            <span class="alert-icon">üîï</span>
                            <span class="alert-text">No alerts set for this item</span>
                        </div>
                        <button class="enable-alert-btn" id="enableAlertBtn" onclick="enableCurrentItemAlert()">Enable Alerts</button>
                    </div>
                </div>
                <small class="alert-help-text">Get notified when someone books this item for pickup</small>
            </div>
            
            <!-- All Booking Alerts -->
            <div class="all-alerts-section">
                <h4>üîî All Your Alerts</h4>
                <div id="allAlertsContainer">
                    <div class="no-alerts" id="noAlertsMessage">
                        <span class="no-alerts-icon">üì≠</span>
                        <p>No booking alerts active</p>
                    </div>
                </div>
            </div>
            
            <!-- Recent Notifications -->
            <div class="recent-notifications-section">
                <h4>üì® Recent Notifications</h4>
                <div id="recentNotificationsContainer">
                    <div class="no-notifications" id="noNotificationsMessage">
                        <span class="no-notifications-icon">üì™</span>
                        <p>No recent notifications</p>
                    </div>
                </div>
            </div>
            
            <div class="notification-actions">
                <button class="manage-all-btn" onclick="openRemindersPage()">üìã Manage All Notifications</button>
            </div>
        </div>
        <!-- Notification Side Panel -->
        <div class="notification-panel" id="notificationPanel">
            <div class="notification-header">
                <h3>üîî Notifications & Alerts</h3>
                <button class="close-panel" onclick="toggleNotificationPanel()">‚úï</button>
            </div>
            
            <!-- Current Item Alert Status -->
            <div class="current-item-alert">
                <h4>üì¶ Current Item Alerts</h4>
                <div id="currentItemAlertStatus">
                    <div class="alert-status-card" id="alertStatusCard">
                        <div class="alert-info">
                            <span class="alert-icon">üîï</span>
                            <span class="alert-text">No alerts set for this item</span>
                        </div>
                        <button class="enable-alert-btn" id="enableAlertBtn" onclick="enableCurrentItemAlert()">Enable Alerts</button>
                    </div>
                </div>
                <small class="alert-help-text">Get notified when someone books this item for pickup</small>
            </div>
            
            <!-- All Booking Alerts -->
            <div class="all-alerts-section">
                <h4>üîî All Your Alerts</h4>
                <div id="allAlertsContainer">
                    <div class="no-alerts" id="noAlertsMessage">
                        <span class="no-alerts-icon">üì≠</span>
                        <p>No booking alerts active</p>
                    </div>
                </div>
            </div>
            
            <!-- Recent Notifications -->
            <div class="recent-notifications-section">
                <h4>üì® Recent Notifications</h4>
                <div id="recentNotificationsContainer">
                    <div class="no-notifications" id="noNotificationsMessage">
                        <span class="no-notifications-icon">üì™</span>
                        <p>No recent notifications</p>
                    </div>
                </div>
            </div>
            
            <div class="notification-actions">
                <button class="manage-all-btn" onclick="openRemindersPage()">üìã Manage All Notifications</button>
            </div>
        </div>
        <!--Product Info Header-->
        <div class="chat-product-header">
            <div class="product-info">
                <img id="productImage" alt="Product Image" class="product-thumbnail">
                <div class="product-details">
                    <h3 id="productName">Loading Product...</h3>
                    <p class="price" id="productPrice">$0</p>
                    <p class="category" id="productCategory">Category</p>
                </div>
            </div>
            <div class="seller-info clickable-seller-card" onclick="showSellerProfile()" title="Click to view seller profile and reviews">
                <div class="seller-avatar">üë®‚Äçüíº</div>
                <div class="seller-details">
                    <h4 id="sellerNameHeader"></h4>
                    <span class="online-status">‚óè Online</span>
                    <div class="view-profile-hint">
                        <span class="hint-icon">üëÅÔ∏è</span>
                        <span class="hint-text">Click to view profile & reviews</span>
                    </div>
                </div>
            </div>
        </div>

        <!--Chat Messages Area-->
        <div class="chat-messages" id="chatMessages">
            <!-- Chat history header will be added here -->
            <div class="chat-history-header" id="chatHistoryHeader" style="display: none;">
                <div class="history-divider">
                    <span class="history-text">Conversation started on <span id="conversationDate"></span></span>
                </div>
            </div>
            <!-- Messages will be loaded dynamically -->
        </div>

        <!--Chat Input Area-->
        <div class="chat-input-container">
            <form id="chatForm" class="chat-form">
                <div class="chat-input-wrapper">
                    <input type="text" id="messageInput" placeholder="Type your message... (Try 'book pickup' to schedule)" autocomplete="off" required>
                    <button type="submit" class="send-btn" title="Send Message">
                        <span class="send-icon">‚û§</span>
                    </button>
                </div>
            </form>
            
            <!-- Booking Quick Actions -->
            <div class="booking-quick-actions">
                <button type="button" class="quick-action-btn" onclick="quickBooking()">üìÖ Quick Booking</button>
                <button type="button" class="quick-action-btn" onclick="checkAvailability()">‚è∞ Check Availability</button>
                <button type="button" class="quick-action-btn" onclick="askLocation()">üìç Ask Location</button>
                <button type="button" class="quick-action-btn" onclick="toggleNotificationPanel()">üîî Alerts</button>
                <button type="button" class="cancel-btn-action" onclick="cancelChat()" title="Cancel chat and return to previous page">
                    ‚úï Cancel Chat
                </button>
            </div>
        </div>
    </div>

    <script>
        // Product data from Flask backend
        const currentProductData = {
            id: {{ item_id }},
            name: "{{ item.name }}",
            price: {{ item.price }},
            image: "{{ item.image }}",
            category: "{{ item.category }}"
        };

        // Get product information from Flask-provided data
        function getCurrentProduct() {
            console.log('Using Flask-provided product data:', currentProductData);
            return currentProductData;
        }

        // Load and display product information
        function loadProductInfo() {
            const product = getCurrentProduct();
            
            console.log('Loading product info for:', product);
            
            // Update product display
            document.getElementById('productName').textContent = product.name;
            document.getElementById('productPrice').textContent = `$${product.price}`;
            document.getElementById('productCategory').textContent = product.category;
            
            // Update product image with fallback
            const productImage = document.getElementById('productImage');
            if (productImage) {
                console.log('Setting image src to:', product.image);
                
                // Set a loading placeholder first
                productImage.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 60 60'%3E%3Crect width='60' height='60' fill='%23007BFF'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-size='12'%3ELoading...%3C/text%3E%3C/svg%3E";
                
                // Handle image load error with fallback
                productImage.onerror = function() {
                    console.log('Image failed to load, using fallback');
                    this.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 60 60'%3E%3Crect width='60' height='60' fill='%23007BFF'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-size='24'%3Eüì¶%3C/text%3E%3C/svg%3E";
                };
                
                // Handle image load success
                productImage.onload = function() {
                    console.log('Image loaded successfully:', this.src);
                };
                
                // Construct proper image path with Flask url_for pattern
                const imagePath = `/static/${product.image}`;
                
                // Set the actual product image after a brief delay to show loading
                setTimeout(() => {
                    productImage.src = imagePath;
                    productImage.alt = product.name;
                }, 100);
            } else {
                console.error('Product image element not found!');
            }
            
            // Update page title
            document.title = `Chat with Seller - ${product.name}`;
            
            return product;
        }

        // Frontend user management
        function getCurrentUser() {
            let user = localStorage.getItem('demo_user');
            if (!user) {
                user = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('demo_user', user);
            }
            return user;
        }

        // Initialize user and product
        const currentUser = getCurrentUser();
        let currentProduct = null;

        function toggleLogout() {
            const logoutText = document.getElementById('logoutText');
            const isVisible = logoutText.style.display !== 'none';
            
            if (isVisible) {
                logoutText.style.display = 'none';
            } else {
                logoutText.style.display = 'inline-block';
            }
        }
        
        function logout() {
            localStorage.removeItem('demo_user');
            // Clear all chat data
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('chat_messages_')) {
                    localStorage.removeItem(key);
                }
            });
            alert('Logged out! Chat data cleared.');
            location.reload();
        }
        
        // Notification Panel Functions
        let notificationPanelOpen = false;
        let currentItemId = null;
        
        function toggleNotificationPanel() {
            const panel = document.getElementById('notificationPanel');
            notificationPanelOpen = !notificationPanelOpen;
            
            if (notificationPanelOpen) {
                panel.classList.add('panel-open');
                loadNotificationData();
            } else {
                panel.classList.remove('panel-open');
            }
        }
        
        function loadNotificationData() {
            updateCurrentItemAlertStatus();
            loadAllBookingAlerts();
            loadRecentNotifications();
            updateNotificationBadge();
        }
        
        function updateCurrentItemAlertStatus() {
            const alertStatusCard = document.getElementById('alertStatusCard');
            if (!alertStatusCard) return;
            
            const alertIcon = alertStatusCard.querySelector('.alert-icon');
            const alertText = alertStatusCard.querySelector('.alert-text');
            const enableBtn = document.getElementById('enableAlertBtn');
            
            const bookingAlerts = JSON.parse(localStorage.getItem('bookingAlerts') || '[]');
            const currentAlert = bookingAlerts.find(alert => alert.itemId === String(currentItemId));
            
            if (currentAlert) {
                alertIcon.textContent = 'üîî';
                alertText.textContent = `Alerts enabled for this item`;
                enableBtn.textContent = 'Disable Alerts';
                enableBtn.style.background = '#f44336';
                alertStatusCard.style.background = '#e8f5e8';
                alertStatusCard.style.borderColor = '#4CAF50';
            } else {
                alertIcon.textContent = 'üîï';
                alertText.textContent = 'No alerts set for this item';
                enableBtn.textContent = 'Enable Alerts';
                enableBtn.style.background = '#4CAF50';
                alertStatusCard.style.background = '#fff3e0';
                alertStatusCard.style.borderColor = '#FF9800';
            }
        }
        
        function enableCurrentItemAlert() {
            const bookingAlerts = JSON.parse(localStorage.getItem('bookingAlerts') || '[]');
            const existingAlert = bookingAlerts.find(alert => alert.itemId === String(currentItemId));
            
            if (existingAlert) {
                // Show custom disable confirmation modal
                const currentProduct = getCurrentProduct();
                showChatAlertDisableModal(currentProduct.name, existingAlert, () => {
                    // User confirmed - proceed with disabling
                    const updatedAlerts = bookingAlerts.filter(alert => alert.itemId !== String(currentItemId));
                    localStorage.setItem('bookingAlerts', JSON.stringify(updatedAlerts));
                    
                    updateCurrentItemAlertStatus();
                    loadAllBookingAlerts();
                    showChatMiniNotification('üîï Alert disabled for this item', '#f44336');
                    addRecentNotification(`Alert disabled for ${currentProduct.name}`, 'Alert Management');
                });
            } else {
                // Show custom enable alert modal
                showChatAlertEnableModal();
            }
        }
        
        function showChatAlertDisableModal(itemName, alertData, onConfirm) {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.id = 'chatAlertDisableOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                backdrop-filter: blur(8px);
                animation: chatFadeIn 0.3s ease-out;
            `;
            
            // Create modal content
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: white;
                padding: 35px;
                border-radius: 20px;
                box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
                max-width: 460px;
                width: 90%;
                text-align: center;
                animation: chatModalSlide 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
                position: relative;
                border: 3px solid;
                border-image: linear-gradient(135deg, #ff6b6b, #ee5a52, #ff8a80) 1;
            `;
            
            const email = alertData ? alertData.email : '';
            const dateCreated = alertData ? new Date(alertData.dateCreated).toLocaleDateString() : '';
            const preferredDate = alertData ? alertData.preferredDate : '';
            const preferredTime = alertData ? alertData.preferredTime : '';
            const preferredLocation = alertData ? alertData.preferredLocation : '';
            
            modal.innerHTML = `
                <div style="margin-bottom: 25px;">
                    <div style="font-size: 3.5rem; margin-bottom: 15px; animation: chatBounce 0.6s ease-out;">üîï</div>
                    <h2 style="color: #d32f2f; margin: 0 0 10px 0; font-size: 1.6rem; font-weight: 700;">
                        Disable Chat Alert?
                    </h2>
                    <p style="color: #666; margin: 0; font-size: 0.95rem; line-height: 1.4;">
                        You'll no longer receive notifications for this item
                    </p>
                </div>
                
                <div style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border-radius: 15px; padding: 20px; margin: 20px 0; border: 2px solid #ffab91;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <span style="font-size: 1.8rem;">üì¶</span>
                        <div style="text-align: left; flex: 1;">
                            <h4 style="margin: 0 0 4px 0; color: #d32f2f; font-size: 1.1rem;">${itemName}</h4>
                            ${email ? `<p style="margin: 2px 0; color: #666; font-size: 0.85rem;">üìß ${email}</p>` : ''}
                            ${dateCreated ? `<p style="margin: 2px 0; color: #666; font-size: 0.85rem;">üìÖ Active since ${dateCreated}</p>` : ''}
                            ${preferredDate ? `<p style="margin: 2px 0; color: #666; font-size: 0.85rem;">üìÖ Preferred: ${preferredDate}${preferredTime ? ` at ${preferredTime}` : ''}</p>` : ''}
                            ${preferredLocation ? `<p style="margin: 2px 0; color: #666; font-size: 0.85rem;">üìç Location: ${preferredLocation}</p>` : ''}
                        </div>
                    </div>
                    
                    <div style="background: rgba(211, 47, 47, 0.1); border-left: 3px solid #d32f2f; padding: 10px 12px; border-radius: 6px;">
                        <p style="margin: 0; color: #b71c1c; font-size: 0.85rem; font-weight: 500;">
                            ‚ö†Ô∏è No more booking notifications for this item
                        </p>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 25px;">
                    <button id="chatConfirmDisable" style="
                        background: linear-gradient(135deg, #f44336, #d32f2f);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 20px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        font-size: 14px;
                        box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
                        min-width: 120px;
                    ">
                        üîï Disable
                    </button>
                    <button id="chatCancelDisable" style="
                        background: linear-gradient(135deg, #2196f3, #1976d2);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 20px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        font-size: 14px;
                        box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
                        min-width: 120px;
                    ">
                        üîî Keep Active
                    </button>
                </div>
                
                <p style="color: #999; font-size: 0.75rem; margin: 15px 0 0 0; font-style: italic;">
                    Press Escape to cancel
                </p>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // Add animation styles
            if (!document.getElementById('chatModalStyles')) {
                const style = document.createElement('style');
                style.id = 'chatModalStyles';
                style.textContent = `
                    @keyframes chatFadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes chatModalSlide {
                        from { 
                            opacity: 0; 
                            transform: translateY(-40px) scale(0.8); 
                        }
                        to { 
                            opacity: 1; 
                            transform: translateY(0) scale(1); 
                        }
                    }
                    @keyframes chatBounce {
                        0%, 20%, 60%, 100% { transform: translateY(0); }
                        40% { transform: translateY(-8px); }
                        80% { transform: translateY(-4px); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Button interactions
            const confirmBtn = modal.querySelector('#chatConfirmDisable');
            const cancelBtn = modal.querySelector('#chatCancelDisable');
            
            [confirmBtn, cancelBtn].forEach(btn => {
                btn.addEventListener('mouseenter', () => {
                    btn.style.transform = 'translateY(-2px) scale(1.02)';
                    btn.style.boxShadow = btn === confirmBtn ? 
                        '0 6px 20px rgba(244, 67, 54, 0.6)' : 
                        '0 6px 20px rgba(33, 150, 243, 0.6)';
                });
                btn.addEventListener('mouseleave', () => {
                    btn.style.transform = 'translateY(0) scale(1)';
                    btn.style.boxShadow = btn === confirmBtn ? 
                        '0 4px 12px rgba(244, 67, 54, 0.4)' : 
                        '0 4px 12px rgba(33, 150, 243, 0.4)';
                });
            });
            
            confirmBtn.addEventListener('click', () => {
                closeChatAlertModal();
                onConfirm();
            });
            
            cancelBtn.addEventListener('click', () => {
                closeChatAlertModal();
                showChatMiniNotification('üîî Alert kept active!', '#4CAF50');
            });
            
            // Close on overlay click and Escape key
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeChatAlertModal();
            });
            
            document.addEventListener('keydown', function escapeHandler(e) {
                if (e.key === 'Escape') {
                    closeChatAlertModal();
                    document.removeEventListener('keydown', escapeHandler);
                }
            });
            
            setTimeout(() => cancelBtn.focus(), 100);
        }
        
        function showChatAlertEnableModal() {
            // Create modal overlay for enabling alerts
            const overlay = document.createElement('div');
            overlay.id = 'chatAlertEnableOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                backdrop-filter: blur(8px);
                animation: chatFadeIn 0.3s ease-out;
            `;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: white;
                padding: 35px;
                border-radius: 20px;
                box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
                max-width: 480px;
                width: 90%;
                text-align: center;
                animation: chatModalSlide 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
                border: 3px solid;
                border-image: linear-gradient(135deg, #4CAF50, #8BC34A, #66BB6A) 1;
            `;
            
            const currentProduct = getCurrentProduct();
            const userEmail = getUserEmail();
            
            modal.innerHTML = `
                <div style="margin-bottom: 25px;">
                    <div style="font-size: 3.5rem; margin-bottom: 15px; animation: chatBounce 0.6s ease-out;">üîî</div>
                    <h2 style="color: #2e7d32; margin: 0 0 10px 0; font-size: 1.6rem; font-weight: 700;">
                        Enable Booking Alerts
                    </h2>
                    <p style="color: #666; margin: 0; font-size: 0.95rem; line-height: 1.4;">
                        Get notified when someone books this item
                    </p>
                </div>
                
                <div style="background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); border-radius: 15px; padding: 20px; margin: 20px 0; border: 2px solid #a5d6a7;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                        <span style="font-size: 1.8rem;">üì¶</span>
                        <div style="text-align: left; flex: 1;">
                            <h4 style="margin: 0 0 4px 0; color: #2e7d32; font-size: 1.1rem;">${currentProduct.name}</h4>
                            <p style="margin: 0; color: #666; font-size: 0.85rem;">You'll be notified instantly via email</p>
                        </div>
                    </div>
                    
                    <div class="email-input-group" style="margin: 15px 0;">
                        <label style="display: block; text-align: left; margin-bottom: 8px; color: #2e7d32; font-weight: 600; font-size: 0.9rem;">
                            üìß Your Email Address:
                        </label>
                        <input type="email" id="chatAlertEmail" placeholder="your.email@example.com" value="${userEmail}" 
                               style="width: 100%; padding: 10px 12px; border: 2px solid #c8e6c9; border-radius: 8px; font-size: 14px; box-sizing: border-box;"
                               required>
                    </div>
                    
                    <div class="time-input-group" style="margin: 15px 0;">
                        <label style="display: block; text-align: left; margin-bottom: 8px; color: #2e7d32; font-weight: 600; font-size: 0.9rem;">
                            ‚è∞ Preferred Pickup Time:
                        </label>
                        <div style="display: flex; gap: 8px;">
                            <input type="date" id="chatAlertDate" 
                                   style="flex: 1; padding: 10px 12px; border: 2px solid #c8e6c9; border-radius: 8px; font-size: 14px;"
                                   min="${new Date().toISOString().split('T')[0]}">
                            <input type="time" id="chatAlertTime" 
                                   style="flex: 1; padding: 10px 12px; border: 2px solid #c8e6c9; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>
                    
                    <div class="location-input-group" style="margin: 15px 0;">
                        <label style="display: block; text-align: left; margin-bottom: 8px; color: #2e7d32; font-weight: 600; font-size: 0.9rem;">
                            üìç Preferred Pickup Location:
                        </label>
                        <input type="text" id="chatAlertLocation" placeholder="e.g., Downtown Mall, Campus Library, Your Address..." 
                               style="width: 100%; padding: 10px 12px; border: 2px solid #c8e6c9; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    </div>
                    
                    <div style="background: rgba(46, 125, 50, 0.1); border-left: 3px solid #4CAF50; padding: 10px 12px; border-radius: 6px; margin-top: 12px;">
                        <p style="margin: 0; color: #1b5e20; font-size: 0.85rem; font-weight: 500;">
                            ‚ú® Instant email notifications when this item gets booked
                        </p>
                        <p style="margin: 5px 0 0 0; color: #2e7d32; font-size: 0.8rem;">
                            üí° Time & location preferences help sellers coordinate pickup
                        </p>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 25px;">
                    <button id="chatConfirmEnable" style="
                        background: linear-gradient(135deg, #4CAF50, #2e7d32);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 20px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        font-size: 14px;
                        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
                        min-width: 130px;
                    ">
                        üîî Enable Alerts
                    </button>
                    <button id="chatCancelEnable" style="
                        background: linear-gradient(135deg, #757575, #424242);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 20px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        font-size: 14px;
                        box-shadow: 0 4px 12px rgba(117, 117, 117, 0.4);
                        min-width: 100px;
                    ">
                        Cancel
                    </button>
                </div>
                
                <p style="color: #999; font-size: 0.75rem; margin: 15px 0 0 0; font-style: italic;">
                    Your email is only used for booking notifications
                </p>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            const emailInput = modal.querySelector('#chatAlertEmail');
            const confirmBtn = modal.querySelector('#chatConfirmEnable');
            const cancelBtn = modal.querySelector('#chatCancelEnable');
            
            // Focus email input
            setTimeout(() => {
                emailInput.focus();
                if (userEmail) emailInput.select();
            }, 100);
            
            // Button interactions
            [confirmBtn, cancelBtn].forEach(btn => {
                btn.addEventListener('mouseenter', () => {
                    btn.style.transform = 'translateY(-2px) scale(1.02)';
                });
                btn.addEventListener('mouseleave', () => {
                    btn.style.transform = 'translateY(0) scale(1)';
                });
            });
            
            confirmBtn.addEventListener('click', () => {
                const email = emailInput.value.trim();
                const date = modal.querySelector('#chatAlertDate').value;
                const time = modal.querySelector('#chatAlertTime').value;
                const location = modal.querySelector('#chatAlertLocation').value.trim();
                
                if (!email || !email.includes('@')) {
                    emailInput.style.borderColor = '#f44336';
                    emailInput.focus();
                    return;
                }
                
                // Save email and enable alert
                localStorage.setItem('userEmail', email);
                
                const currentProduct = getCurrentProduct();
                const bookingAlerts = JSON.parse(localStorage.getItem('bookingAlerts') || '[]');
                const alertData = {
                    itemId: String(currentItemId),
                    itemName: currentProduct.name,
                    email: email,
                    preferredDate: date,
                    preferredTime: time,
                    preferredLocation: location,
                    enabled: true,
                    dateCreated: new Date().toISOString(),
                    emailSent: false
                };
                
                bookingAlerts.push(alertData);
                localStorage.setItem('bookingAlerts', JSON.stringify(bookingAlerts));
                
                closeChatAlertModal('chatAlertEnableOverlay');
                updateCurrentItemAlertStatus();
                loadAllBookingAlerts();
                
                let message = '‚úÖ Booking alerts enabled!';
                if (date || time || location) {
                    message += ' Preferences saved.';
                }
                showChatMiniNotification(message, '#4CAF50');
                addRecentNotification(`Alerts enabled for ${currentProduct.name}`, 'Alert Setup');
            });
            
            cancelBtn.addEventListener('click', () => {
                closeChatAlertModal('chatAlertEnableOverlay');
            });
            
            // Close handlers
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeChatAlertModal('chatAlertEnableOverlay');
            });
            
            document.addEventListener('keydown', function escapeHandler(e) {
                if (e.key === 'Escape') {
                    closeChatAlertModal('chatAlertEnableOverlay');
                    document.removeEventListener('keydown', escapeHandler);
                }
            });
        }
        
        function closeChatAlertModal(overlayId = 'chatAlertDisableOverlay') {
            const overlay = document.getElementById(overlayId);
            if (overlay) {
                overlay.style.animation = 'fadeOut 0.3s ease-in';
                setTimeout(() => overlay.remove(), 300);
            }
        }
        
        function showChatMiniNotification(message, color = '#4CAF50') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${color};
                color: white;
                padding: 12px 20px;
                border-radius: 20px;
                font-weight: 600;
                font-size: 14px;
                z-index: 10001;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                animation: slideInRight 0.4s ease-out;
                max-width: 300px;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.4s ease-in';
                setTimeout(() => notification.remove(), 400);
            }, 3000);
        }
        
        function loadAllBookingAlerts() {
            const container = document.getElementById('allAlertsContainer');
            if (!container) return;
            
            const noAlertsMessage = document.getElementById('noAlertsMessage');
            const bookingAlerts = JSON.parse(localStorage.getItem('bookingAlerts') || '[]');
            
            // Clear existing alerts
            const existingAlerts = container.querySelectorAll('.alert-item');
            existingAlerts.forEach(alert => alert.remove());
            
            if (bookingAlerts.length === 0) {
                if (noAlertsMessage) noAlertsMessage.style.display = 'block';
                return;
            }
            
            if (noAlertsMessage) noAlertsMessage.style.display = 'none';
            
            bookingAlerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert-item';
                alertDiv.innerHTML = `
                    <div class="alert-header">
                        <span class="alert-name">üì¶ ${alert.itemName}</span>
                        <span class="alert-status">üîî Active</span>
                    </div>
                    <div class="alert-details">
                        <small>Since ${new Date(alert.dateCreated).toLocaleDateString()}</small>
                    </div>
                `;
                
                if (alert.itemId === String(currentItemId)) {
                    alertDiv.style.background = '#e8f5e8';
                    alertDiv.style.borderColor = '#4CAF50';
                }
                
                container.appendChild(alertDiv);
            });
        }
        
        function loadRecentNotifications() {
            const container = document.getElementById('recentNotificationsContainer');
            if (!container) return;
            
            const noNotificationsMessage = document.getElementById('noNotificationsMessage');
            const recentNotifications = JSON.parse(localStorage.getItem('recentNotifications') || '[]');
            
            // Clear existing notifications
            const existingNotifications = container.querySelectorAll('.notification-item');
            existingNotifications.forEach(notification => notification.remove());
            
            if (recentNotifications.length === 0) {
                if (noNotificationsMessage) noNotificationsMessage.style.display = 'block';
                return;
            }
            
            if (noNotificationsMessage) noNotificationsMessage.style.display = 'none';
            
            // Show only last 3 notifications in chat panel
            const recentThree = recentNotifications.slice(0, 3);
            
            recentThree.forEach(notification => {
                const notificationDiv = document.createElement('div');
                notificationDiv.className = 'notification-item';
                notificationDiv.innerHTML = `
                    <div class="notification-header">
                        <span class="notification-type">${notification.type}</span>
                        <span class="notification-time">${notification.timestamp}</span>
                    </div>
                    <div class="notification-message">${notification.message}</div>
                `;
                container.appendChild(notificationDiv);
            });
        }
        
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (!badge) return;
            
            const bookingAlerts = JSON.parse(localStorage.getItem('bookingAlerts') || '[]');
            const recentNotifications = JSON.parse(localStorage.getItem('recentNotifications') || '[]');
            
            const unreadCount = recentNotifications.filter(n => !n.read).length;
            const alertCount = bookingAlerts.length;
            
            const totalCount = unreadCount + alertCount;
            
            if (totalCount > 0) {
                badge.textContent = totalCount;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }
        
        function addRecentNotification(message, type) {
            const recentNotifications = JSON.parse(localStorage.getItem('recentNotifications') || '[]');
            const notification = {
                message: message,
                type: type,
                timestamp: new Date().toLocaleTimeString(),
                id: Date.now(),
                read: false
            };
            
            recentNotifications.unshift(notification);
            
            // Keep only last 10 notifications
            if (recentNotifications.length > 10) {
                recentNotifications.splice(10);
            }
            
            localStorage.setItem('recentNotifications', JSON.stringify(recentNotifications));
            
            if (notificationPanelOpen) {
                loadRecentNotifications();
            }
            updateNotificationBadge();
        }
        
        function getUserEmail() {
            return localStorage.getItem('userEmail') || '';
        }
        
        function loadCurrentUser() {
            // Initialize current user if needed
            const user = getCurrentUser();
            console.log('Current user loaded:', user);
        }
        
        function openRemindersPage() {
            window.location.href = `/reminder?item_id=${currentItemId}&item_name=${encodeURIComponent(getCurrentProduct().name)}&action=manage_all`;
        }
        
        function loadSellerInfo() {
            // Dynamic seller names based on item ID
            const sellers = {
                0: 'Alex Thompson',
                1: 'Sarah Johnson', 
                2: 'Mike Chen',
                3: 'Emily Davis',
                4: 'David Wilson',
                5: 'Lisa Garcia'
            };
            
            const sellerName = sellers[currentItemId] || 'Seller';
            const sellerNameElement = document.getElementById('sellerNameHeader');
            
            if (sellerNameElement) {
                sellerNameElement.textContent = sellerName;
            }
        }
        
        function showSellerProfile() {
            const sellerName = document.getElementById('sellerNameHeader').textContent;
            
            // Navigate to review page with seller parameter
            window.location.href = `/review?seller=${encodeURIComponent(sellerName)}&item_id=${currentItemId}`;
        }

        // Chat functionality
        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');

        // Auto-scroll to bottom
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Add message to chat with enhanced metadata
        function addMessage(content, isUser = true, timestamp = null, messageId = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'seller-message'}`;
            
            const currentTime = timestamp || new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const msgId = messageId || Date.now() + Math.random();
            
            messageDiv.setAttribute('data-message-id', msgId);
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="message-bubble">
                        <p>${content}</p>
                        <div class="message-meta">
                            <span class="message-time">${currentTime}</span>
                            ${isUser ? '<span class="message-status" title="Sent">‚úì</span>' : ''}
                        </div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
            
            return msgId;
        }

        // Handle form submission
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            if (message) {
                // Add user message immediately
                const messageId = addMessage(message, true);
                const userMessage = message;
                messageInput.value = '';
                
                // Save message to localStorage
                saveMessageToStorage(userMessage, true, messageId);
                
                // Show sending indicator briefly
                const sendingIndicator = addTypingIndicator('Sending...');
                
                // Simulate network delay and remove sending indicator
                setTimeout(() => {
                    if (sendingIndicator) sendingIndicator.remove();
                }, 500);
                
                // Simulate seller response with varied timing
                setTimeout(() => {
                    let randomResponse;
                    
                    // Get existing messages to check if this is the first user message
                    const chatKey = getChatKey();
                    const existingMessages = JSON.parse(localStorage.getItem(chatKey) || '[]');
                    const isFirstMessage = existingMessages.filter(msg => msg.isUser).length === 1; // Only one user message (the one just sent)
                    
                    // If this is the first message, start with a welcome response
                    if (isFirstMessage) {
                        randomResponse = `Hi! Thanks for your interest in ${currentProduct.name}. How can I help you?`;
                    } else {
                        // Check if message contains booking-related keywords
                        if (userMessage.toLowerCase().includes('book') || userMessage.toLowerCase().includes('pickup') || userMessage.toLowerCase().includes('schedule')) {
                            const bookingResponses = [
                                "Great! I'm available for pickup. When works best for you? I'm free Mon-Sat 9AM-7PM.",
                                "Perfect! Let's schedule your pickup. I can meet today after 2PM or tomorrow morning. What's your preference?",
                                "Excellent! For pickup, I'm available weekdays after 5PM and weekends anytime. What day works for you?",
                                "Sure thing! I can arrange pickup. My location is near downtown. When would you like to collect it?",
                                "Absolutely! I'm flexible with pickup times. Are you available this weekend? I can meet at a convenient location.",
                                "Of course! Let's book your pickup. I prefer daytime meetings for safety. How about tomorrow at 11AM?"
                            ];
                            randomResponse = bookingResponses[Math.floor(Math.random() * bookingResponses.length)];
                        } else if (userMessage.toLowerCase().includes('available') || userMessage.toLowerCase().includes('still')) {
                            const availabilityResponses = [
                                "Yes, it's still available! Would you like to arrange a pickup time?",
                                "Absolutely! The item is ready for pickup. When would you like to schedule?",
                                "Yes, still available! I can arrange pickup as early as today if you're interested.",
                                "It's yours if you want it! When would be a good time for pickup?",
                                "Still available! Several people have asked, so let me know if you'd like to book pickup soon."
                            ];
                            randomResponse = availabilityResponses[Math.floor(Math.random() * availabilityResponses.length)];
                        } else if (userMessage.toLowerCase().includes('location') || userMessage.toLowerCase().includes('where')) {
                            const locationResponses = [
                                "I'm located near [Location]. We can meet at the shopping center or I can provide my exact address once we confirm the pickup time.",
                                "I'm in the downtown area. Would you prefer to meet at a public place like the library or coffee shop?",
                                "My location is [Area]. I usually meet at the local mall for safety. Does that work for you?",
                                "I'm near [Landmark]. We can arrange a safe meeting spot once you're ready to pickup."
                            ];
                            randomResponse = locationResponses[Math.floor(Math.random() * locationResponses.length)];
                        } else if (userMessage.toLowerCase().includes('price') || userMessage.toLowerCase().includes('negotiate')) {
                            const priceResponses = [
                                "The listed price is fair, but I'm open to reasonable offers. What did you have in mind?",
                                "Price is negotiable! Make me an offer and we can discuss during pickup.",
                                "I'm flexible on price for serious buyers. What's your budget?",
                                "For quick pickup, I might consider a small discount. What's your offer?"
                            ];
                            randomResponse = priceResponses[Math.floor(Math.random() * priceResponses.length)];
                        } else {
                            const generalResponses = [
                                "Thanks for your interest! This item is in great condition.",
                                "Yes, it's still available. Would you like more details?",
                                "I can provide more photos if you'd like to see them.",
                                "Feel free to ask any questions about the item!",
                                "I can arrange a meeting for you to see it in person.",
                                "This is one of my best items. Very well maintained!",
                                "Let me know if you need any additional information.",
                                "I'm available to meet this week if you're interested.",
                                "Would you like to know more about its features?",
                                "The item is exactly as shown in the photos."
                            ];
                            randomResponse = generalResponses[Math.floor(Math.random() * generalResponses.length)];
                        }
                    }
                    
                    const responseId = addMessage(randomResponse, false);
                    
                    // Save seller response to localStorage
                    saveMessageToStorage(randomResponse, false, responseId);
                }, 1500 + Math.random() * 2500);
            }
        });

        // Save message to localStorage
        function getChatKey() {
            return `chat_messages_user_${currentUser}_item_${currentProduct.id}`;
        }

        function saveMessageToStorage(message, isUser, messageId = null) {
            const chatKey = getChatKey();
            let messages = JSON.parse(localStorage.getItem(chatKey) || '[]');
            
            const messageObj = {
                id: messageId || Date.now() + Math.random(),
                content: message,
                isUser: isUser,
                timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                fullTimestamp: new Date().toISOString(),
                date: new Date().toDateString()
            };
            
            messages.push(messageObj);
            
            // Keep only last 100 messages to prevent storage bloat
            if (messages.length > 100) {
                messages = messages.slice(-100);
            }
            
            localStorage.setItem(chatKey, JSON.stringify(messages));
            
            // Update conversation start date
            updateConversationStartDate(messages);
        }

        // Load messages from localStorage with enhanced display
        function loadMessagesFromStorage() {
            const chatKey = getChatKey();
            const messages = JSON.parse(localStorage.getItem(chatKey) || '[]');
            
            if (messages.length > 0) {
                // Show loading indicator for large chat histories
                if (messages.length > 10) {
                    showChatLoadingIndicator();
                }
                
                // Show conversation start date
                updateConversationStartDate(messages);
                
                // Group messages by date if conversation spans multiple days
                const messagesByDate = groupMessagesByDate(messages);
                
                // Load messages with slight delay for better UX
                let loadDelay = 0;
                Object.keys(messagesByDate).forEach((date, dateIndex) => {
                    setTimeout(() => {
                        // Add date separator if needed
                        if (Object.keys(messagesByDate).length > 1) {
                            addDateSeparator(date);
                        }
                        
                        // Add messages for this date
                        messagesByDate[date].forEach((msg, msgIndex) => {
                            setTimeout(() => {
                                addMessage(msg.content, msg.isUser, msg.timestamp, msg.id);
                            }, msgIndex * 50); // Small delay between messages for smooth loading
                        });
                    }, loadDelay);
                    
                    loadDelay += messagesByDate[date].length * 50 + 200; // Delay between dates
                });
                
                // Hide loading indicator after messages are loaded
                if (messages.length > 10) {
                    setTimeout(() => {
                        hideChatLoadingIndicator();
                    }, loadDelay + 500);
                }
            }
        }
        
        function showChatLoadingIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'chatLoadingIndicator';
            indicator.className = 'chat-loading-indicator';
            indicator.innerHTML = `
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <span class="loading-text">Restoring chat history...</span>
                </div>
            `;
            chatMessages.appendChild(indicator);
        }
        
        function hideChatLoadingIndicator() {
            const indicator = document.getElementById('chatLoadingIndicator');
            if (indicator) {
                indicator.style.transition = 'opacity 0.3s ease';
                indicator.style.opacity = '0';
                setTimeout(() => {
                    if (indicator.parentNode) {
                        indicator.remove();
                    }
                }, 300);
            }
        }
        
        function updateConversationStartDate(messages) {
            if (messages.length > 0) {
                const firstMessage = messages[0];
                const startDate = firstMessage.fullTimestamp ? 
                    new Date(firstMessage.fullTimestamp).toLocaleDateString() : 
                    new Date().toLocaleDateString();
                    
                const header = document.getElementById('chatHistoryHeader');
                const dateSpan = document.getElementById('conversationDate');
                
                if (header && dateSpan) {
                    dateSpan.textContent = startDate;
                    header.style.display = 'block';
                }
            }
        }
        
        function groupMessagesByDate(messages) {
            const grouped = {};
            
            messages.forEach(msg => {
                const date = msg.date || new Date().toDateString();
                if (!grouped[date]) {
                    grouped[date] = [];
                }
                grouped[date].push(msg);
            });
            
            return grouped;
        }
        
        function addDateSeparator(date) {
            const separator = document.createElement('div');
            separator.className = 'date-separator';
            separator.innerHTML = `
                <div class="date-line">
                    <span class="date-text">${date}</span>
                </div>
            `;
            chatMessages.appendChild(separator);
        }

        // Add typing indicator function
        function addTypingIndicator(text) {
            const indicatorDiv = document.createElement('div');
            indicatorDiv.className = 'message seller-message typing-indicator';
            indicatorDiv.innerHTML = `
                <div class="message-avatar">‚è≥</div>
                <div class="message-content">
                    <div class="message-bubble">
                        <p>${text}</p>
                    </div>
                </div>
            `;
            chatMessages.appendChild(indicatorDiv);
            scrollToBottom();
            return indicatorDiv;
        }

        // Clear chat function with confirmation
        function clearChat() {
            if (confirm('Are you sure you want to clear all chat history? This cannot be undone.')) {
                const chatKey = getChatKey();
                localStorage.removeItem(chatKey);
                chatMessages.innerHTML = '';
                
                // Hide history header
                const header = document.getElementById('chatHistoryHeader');
                if (header) header.style.display = 'none';
                
                // Show confirmation
                addSystemMessage('Chat history cleared');
            }
        }
        
        // Show welcome back message for returning users
        function showWelcomeBackMessage(messages) {
            const lastMessage = messages[messages.length - 1];
            const lastMessageTime = lastMessage.fullTimestamp ? new Date(lastMessage.fullTimestamp) : new Date();
            const timeDiff = new Date() - lastMessageTime;
            const hoursDiff = Math.floor(timeDiff / (1000 * 60 * 60));
            
            // Only show welcome back if it's been more than 1 hour
            if (hoursDiff >= 1) {
                let welcomeText;
                if (hoursDiff < 24) {
                    welcomeText = `Welcome back! Your conversation was last active ${hoursDiff} hour${hoursDiff > 1 ? 's' : ''} ago.`;
                } else {
                    const daysDiff = Math.floor(hoursDiff / 24);
                    welcomeText = `Welcome back! Your conversation was last active ${daysDiff} day${daysDiff > 1 ? 's' : ''} ago.`;
                }
                
                // Add system message after a brief delay
                setTimeout(() => {
                    addSystemMessage(welcomeText);
                }, 1000);
            }
            
            console.log(`Chat reopened. Found ${messages.length} previous messages.`);
        }
        
        // Show message for first time users
        function showFirstTimeMessage() {
            console.log('First time opening chat for this item.');
            
            // Add a subtle hint about starting the conversation
            setTimeout(() => {
                addSystemMessage('Start the conversation by sending a message to the seller');
            }, 2000);
        }
        
        // Enhanced system message with auto-hide
        function addSystemMessage(content, autoHide = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system-message';
            messageDiv.innerHTML = `
                <div class="system-content">
                    <span class="system-text">${content}</span>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
            
            // Auto-hide system messages after 5 seconds
            if (autoHide) {
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.style.transition = 'opacity 0.5s ease';
                        messageDiv.style.opacity = '0';
                        setTimeout(() => {
                            if (messageDiv.parentNode) {
                                messageDiv.remove();
                            }
                        }, 500);
                    }
                }, 5000);
            }
        }
        
        // Export chat history (for user backup)
        function exportChatHistory() {
            const chatKey = getChatKey();
            const messages = JSON.parse(localStorage.getItem(chatKey) || '[]');
            
            if (messages.length === 0) {
                alert('No chat history to export.');
                return;
            }
            
            const productName = currentProduct ? currentProduct.name : 'Unknown Item';
            const exportData = {
                product: productName,
                itemId: currentItemId,
                exportDate: new Date().toISOString(),
                messages: messages
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `chat-history-${productName.replace(/[^a-z0-9]/gi, '_')}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }
        
        // Get chat statistics
        function getChatStats() {
            const chatKey = getChatKey();
            const messages = JSON.parse(localStorage.getItem(chatKey) || '[]');
            
            const userMessages = messages.filter(m => m.isUser);
            const sellerMessages = messages.filter(m => !m.isUser);
            
            return {
                totalMessages: messages.length,
                userMessages: userMessages.length,
                sellerMessages: sellerMessages.length,
                conversationStarted: messages.length > 0 ? messages[0].fullTimestamp : null,
                lastActivity: messages.length > 0 ? messages[messages.length - 1].fullTimestamp : null
            };
        }

        // Add keyboard shortcuts for chat management
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                clearChat();
            } else if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                exportChatHistory();
            } else if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();
                const stats = getChatStats();
                alert(`Chat Statistics:\nTotal Messages: ${stats.totalMessages}\nYour Messages: ${stats.userMessages}\nSeller Messages: ${stats.sellerMessages}`);
            }
        });

        // Typing indicator functionality
        let typingTimeout;
        let isTyping = false;
        let typingIndicator = null;

        messageInput.addEventListener('input', function() {
            if (!isTyping) {
                isTyping = true;
                typingIndicator = addTypingIndicator('You are typing...');
            }
            
            clearTimeout(typingTimeout);
            
            typingTimeout = setTimeout(() => {
                if (typingIndicator) {
                    typingIndicator.remove();
                    typingIndicator = null;
                }
                isTyping = false;
            }, 1000);
        });

        // Enter key support for sending messages
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });

        // Initialize the chat
        document.addEventListener('DOMContentLoaded', function() {
            // Use Flask-provided item_id directly
            currentItemId = {{ item_id }};
            localStorage.setItem('currentItemId', currentItemId);
            
            console.log('Chat initialized for item ID:', currentItemId);
            
            // Load product information first
            currentProduct = loadProductInfo();
            
            // Load seller information
            loadSellerInfo();
            
            // Initialize notification system
            updateNotificationBadge();
            
            // Load current user information
            loadCurrentUser();
            
            // Check for existing chat history before loading
            const chatKey = getChatKey();
            const existingMessages = JSON.parse(localStorage.getItem(chatKey) || '[]');
            
            // Load existing messages from localStorage
            loadMessagesFromStorage();
            
            // If there are existing messages, show a welcome back message
            if (existingMessages.length > 0) {
                showWelcomeBackMessage(existingMessages);
            } else {
                // First time opening this chat - show empty state
                showFirstTimeMessage();
            }
            
            // Auto-focus input
            messageInput.focus();
            
            // Initial scroll to bottom
            scrollToBottom();
        });

        // Booking Quick Action Functions
        function quickBooking() {
            const bookingMessage = "Hi! I'd like to book a pickup time for this item. When are you available?";
            messageInput.value = bookingMessage;
            messageInput.focus();
        }

        function checkAvailability() {
            const availabilityMessage = "Is this item still available? What pickup times work for you?";
            messageInput.value = availabilityMessage;
            messageInput.focus();
        }

        function askLocation() {
            const locationMessage = "Could you please share the pickup location or suggest a safe meeting place?";
            messageInput.value = locationMessage;
            messageInput.focus();
        }
        
        // Handle page visibility changes (when user switches tabs or returns)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // User returned to the chat tab
                console.log('User returned to chat');
                
                // Refresh notification badge
                updateNotificationBadge();
                
                // Check for new messages (in a real app, this would sync with server)
                const chatKey = getChatKey();
                const currentMessages = JSON.parse(localStorage.getItem(chatKey) || '[]');
                
                // Auto-scroll to bottom if user was at bottom before
                const chatContainer = document.getElementById('chatMessages');
                const isAtBottom = chatContainer.scrollTop + chatContainer.clientHeight >= chatContainer.scrollHeight - 50;
                
                if (isAtBottom) {
                    setTimeout(scrollToBottom, 100);
                }
            }
        });
        
        // Store last activity timestamp
        function updateLastActivity() {
            localStorage.setItem('lastChatActivity', new Date().toISOString());
        }
        
        // Update activity on user interactions
        messageInput.addEventListener('focus', updateLastActivity);
        messageInput.addEventListener('input', updateLastActivity);
        document.addEventListener('click', updateLastActivity);
        
        // Cancel chat functionality
        function cancelChat() {
            // Check if there are unsaved messages in the input
            const currentMessage = messageInput.value.trim();
            
            if (currentMessage) {
                // Show confirmation if user has typed something
                if (confirm('You have an unsaved message. Are you sure you want to cancel and leave this chat?')) {
                    performCancelAction();
                }
            } else {
                // No unsaved content, just leave
                performCancelAction();
            }
        }
        
        function performCancelAction() {
            // Check if there's a previous page in history
            if (window.history.length > 1) {
                window.history.back();
            } else {
                // Fallback to products page if no history
                window.location.href = '/products';
            }
        }
        
        // Enhanced cancel with different behavior based on chat state
        function smartCancel() {
            const chatKey = getChatKey();
            const existingMessages = JSON.parse(localStorage.getItem(chatKey) || '[]');
            const currentMessage = messageInput.value.trim();
            
            // If there are messages or unsaved content, show confirmation
            if (existingMessages.length > 0 || currentMessage) {
                const confirmMessage = existingMessages.length > 0 ? 
                    'You have an active conversation. Are you sure you want to leave?' :
                    'You have an unsaved message. Are you sure you want to cancel?';
                    
                if (confirm(confirmMessage)) {
                    performCancelAction();
                }
            } else {
                // No chat history or unsaved content
                performCancelAction();
            }
        }
    </script>
</body>
</html>