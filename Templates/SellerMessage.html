<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Seller Message</title>
  <link rel="stylesheet" href="../static/style.css">
</head>
<body>
    <!--Navbar-->
    <nav class="navbar">
        <div class="nav-left">
            <button onclick="history.back()" class="back-btn" title="Go Back">‚Üê</button>
            <h2>Chat with Seller</h2>
        </div>
        
        <div class="nav-right">
            <!-- Current User Display -->
            <div class="current-user-display">
                <span class="user-name" id="currentUserName"></span>
            </div>
            
            <!-- Notification Bell Icon -->
            <div class="notification-bell" onclick="toggleNotificationPanel()" title="Booking Alerts & Notifications">
                <span class="bell-icon">üîî</span>
                <span class="notification-badge" id="notificationBadge">0</span>
            </div>
            
            <!-- User Icon - Logout -->
            <div class="user-icon-container">
                <span class="user-icon" onclick="toggleLogout()" title="Click to show logout option">‚öôÔ∏è</span>
                <span class="logout-text" id="logoutText" onclick="logout()" style="display: none;">Logout</span>
            </div>
        </div>
    </nav>

    <!--Chat Container-->
    <div class="chat-container">
        <!-- Notification Side Panel -->
        <div class="notification-panel" id="notificationPanel">
            <div class="notification-header">
                <h3>üîî Notifications & Alerts</h3>
                <button class="close-panel" onclick="toggleNotificationPanel()">‚úï</button>
            </div>
            
            <!-- Current Item Alert Status -->
            <div class="current-item-alert">
                <h4>üì¶ Current Item Alerts</h4>
                <div id="currentItemAlertStatus">
                    <div class="alert-status-card" id="alertStatusCard">
                        <div class="alert-info">
                            <span class="alert-icon">üîï</span>
                            <span class="alert-text">No alerts set for this item</span>
                        </div>
                        <button class="enable-alert-btn" id="enableAlertBtn" onclick="enableCurrentItemAlert()">Enable Alerts</button>
                    </div>
                </div>
                <small class="alert-help-text">Get notified when someone books this item for pickup</small>
            </div>
            
            <!-- All Booking Alerts -->
            <div class="all-alerts-section">
                <h4>üîî All Your Alerts</h4>
                <div id="allAlertsContainer">
                    <div class="no-alerts" id="noAlertsMessage">
                        <span class="no-alerts-icon">üì≠</span>
                        <p>No booking alerts active</p>
                    </div>
                </div>
            </div>
            
            <!-- Recent Notifications -->
            <div class="recent-notifications-section">
                <h4>üì® Recent Notifications</h4>
                <div id="recentNotificationsContainer">
                    <div class="no-notifications" id="noNotificationsMessage">
                        <span class="no-notifications-icon">üì™</span>
                        <p>No recent notifications</p>
                    </div>
                </div>
            </div>
            
            <div class="notification-actions">
                <button class="manage-all-btn" onclick="openRemindersPage()">üìã Manage All Notifications</button>
            </div>
        </div>
        <!-- Notification Side Panel -->
        <div class="notification-panel" id="notificationPanel">
            <div class="notification-header">
                <h3>üîî Notifications & Alerts</h3>
                <button class="close-panel" onclick="toggleNotificationPanel()">‚úï</button>
            </div>
            
            <!-- Current Item Alert Status -->
            <div class="current-item-alert">
                <h4>üì¶ Current Item Alerts</h4>
                <div id="currentItemAlertStatus">
                    <div class="alert-status-card" id="alertStatusCard">
                        <div class="alert-info">
                            <span class="alert-icon">üîï</span>
                            <span class="alert-text">No alerts set for this item</span>
                        </div>
                        <button class="enable-alert-btn" id="enableAlertBtn" onclick="enableCurrentItemAlert()">Enable Alerts</button>
                    </div>
                </div>
                <small class="alert-help-text">Get notified when someone books this item for pickup</small>
            </div>
            
            <!-- All Booking Alerts -->
            <div class="all-alerts-section">
                <h4>üîî All Your Alerts</h4>
                <div id="allAlertsContainer">
                    <div class="no-alerts" id="noAlertsMessage">
                        <span class="no-alerts-icon">üì≠</span>
                        <p>No booking alerts active</p>
                    </div>
                </div>
            </div>
            
            <!-- Recent Notifications -->
            <div class="recent-notifications-section">
                <h4>üì® Recent Notifications</h4>
                <div id="recentNotificationsContainer">
                    <div class="no-notifications" id="noNotificationsMessage">
                        <span class="no-notifications-icon">üì™</span>
                        <p>No recent notifications</p>
                    </div>
                </div>
            </div>
            
            <div class="notification-actions">
                <button class="manage-all-btn" onclick="openRemindersPage()">üìã Manage All Notifications</button>
            </div>
        </div>
        <!--Product Info Header-->
        <div class="chat-product-header">
            <div class="product-info">
                <img id="productImage" alt="Product Image" class="product-thumbnail">
                <div class="product-details">
                    <h3 id="productName">Loading Product...</h3>
                    <p class="price" id="productPrice">$0</p>
                    <p class="category" id="productCategory">Category</p>
                </div>
            </div>
            <div class="seller-info">
                <div class="seller-avatar">üë®‚Äçüíº</div>
                <div class="seller-details">
                    <h4 class="clickable-seller" id="sellerNameHeader" onclick="showSellerProfile()" title="View seller profile"></h4>
                    <span class="online-status">‚óè Online</span>
                </div>
            </div>
        </div>

        <!--Chat Messages Area-->
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be loaded dynamically -->
        </div>

        <!--Chat Input Area-->
        <div class="chat-input-container">
            <form id="chatForm" class="chat-form">
                <div class="chat-input-wrapper">
                    <input type="text" id="messageInput" placeholder="Type your message... (Try 'book pickup' to schedule)" autocomplete="off" required>
                    <button type="submit" class="send-btn" title="Send Message">
                        <span class="send-icon">‚û§</span>
                    </button>
                </div>
            </form>
            
            <!-- Booking Quick Actions -->
            <div class="booking-quick-actions">
                <button type="button" class="quick-action-btn" onclick="quickBooking()">üìÖ Quick Booking</button>
                <button type="button" class="quick-action-btn" onclick="checkAvailability()">‚è∞ Check Availability</button>
                <button type="button" class="quick-action-btn" onclick="askLocation()">üìç Ask Location</button>
                <button type="button" class="quick-action-btn" onclick="toggleNotificationPanel()">üîî Alerts</button>
            </div>
        </div>
    </div>

    <script>
        // Sample product data (in a real app, this would come from your backend/API)
        const sampleProducts = [
            {
                id: 0,
                name: "Smart Watch",
                price: 89,
                image: "../static/images/daniel-korpai-hbTKIbuMmBI-unsplash.jpg",
                category: "Electronics"
            },
            {
                id: 1,
                name: "Laptop",
                price: 59,
                image: "../static/images/kompjuteri-com-Saj5h85DbOs-unsplash.jpg",
                category: "Electronics"
            },
            {
                id: 2,
                name: "Pants",
                price: 20,
                image: "../static/images/matthew-moloney-YeGao3uk8kI-unsplash.jpg",
                category: "Clothing"
            },
            {
                id: 3,
                name: "T-Shirts",
                price: 15,
                image: "../static/images/ryan-hoffman-6Nub980bI3I-unsplash.jpg",
                category: "Clothing"
            },
            {
                id: 4,
                name: "Smart Phone",
                price: 55,
                image: "../static/images/shiwa-id-Uae7ouMw91A-unsplash.jpg",
                category: "Electronics"
            },
            {
                id: 5,
                name: "Shoes",
                price: 20,
                image: "../static/images/xavier-teo-SxAXphIPWeg-unsplash.jpg",
                category: "Fashion"
            }
        ];

        // Get product information from URL parameters or default to first product
        function getCurrentProduct() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('product') || urlParams.get('item') || '0';
            const productIndex = parseInt(productId, 10);
            
            console.log('URL params:', window.location.search);
            console.log('Product ID from URL:', productId);
            console.log('Product Index:', productIndex);
            
            // Return the product if it exists, otherwise return the first product as default
            const selectedProduct = sampleProducts[productIndex] || sampleProducts[0];
            console.log('Selected product:', selectedProduct);
            
            return selectedProduct;
        }

        // Load and display product information
        function loadProductInfo() {
            const product = getCurrentProduct();
            
            console.log('Loading product info for:', product);
            
            // Update product display
            document.getElementById('productName').textContent = product.name;
            document.getElementById('productPrice').textContent = `$${product.price}`;
            document.getElementById('productCategory').textContent = product.category;
            
            // Update product image with fallback
            const productImage = document.getElementById('productImage');
            if (productImage) {
                console.log('Setting image src to:', product.image);
                
                // Set a loading placeholder first
                productImage.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 60 60'%3E%3Crect width='60' height='60' fill='%23007BFF'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-size='12'%3ELoading...%3C/text%3E%3C/svg%3E";
                
                // Handle image load error with fallback
                productImage.onerror = function() {
                    console.log('Image failed to load, using fallback');
                    this.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 60 60'%3E%3Crect width='60' height='60' fill='%23007BFF'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-size='24'%3Eüì¶%3C/text%3E%3C/svg%3E";
                };
                
                // Handle image load success
                productImage.onload = function() {
                    console.log('Image loaded successfully:', this.src);
                };
                
                // Set the actual product image after a brief delay to show loading
                setTimeout(() => {
                    productImage.src = product.image;
                    productImage.alt = product.name;
                }, 100);
            } else {
                console.error('Product image element not found!');
            }
            
            // Update page title
            document.title = `Chat with Seller - ${product.name}`;
            
            return product;
        }

        // Frontend user management
        function getCurrentUser() {
            let user = localStorage.getItem('demo_user');
            if (!user) {
                user = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('demo_user', user);
            }
            return user;
        }

        // Initialize user and product
        const currentUser = getCurrentUser();
        let currentProduct = null;

        function toggleLogout() {
            const logoutText = document.getElementById('logoutText');
            const isVisible = logoutText.style.display !== 'none';
            
            if (isVisible) {
                logoutText.style.display = 'none';
            } else {
                logoutText.style.display = 'inline-block';
            }
        }
        
        function logout() {
            localStorage.removeItem('demo_user');
            // Clear all chat data
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('chat_messages_')) {
                    localStorage.removeItem(key);
                }
            });
            alert('Logged out! Chat data cleared.');
            location.reload();
        }
        
        // Notification Panel Functions
        let notificationPanelOpen = false;
        let currentItemId = null;
        
        function toggleNotificationPanel() {
            const panel = document.getElementById('notificationPanel');
            notificationPanelOpen = !notificationPanelOpen;
            
            if (notificationPanelOpen) {
                panel.classList.add('panel-open');
                loadNotificationData();
            } else {
                panel.classList.remove('panel-open');
            }
        }
        
        function loadNotificationData() {
            updateCurrentItemAlertStatus();
            loadAllBookingAlerts();
            loadRecentNotifications();
            updateNotificationBadge();
        }
        
        function updateCurrentItemAlertStatus() {
            const alertStatusCard = document.getElementById('alertStatusCard');
            if (!alertStatusCard) return;
            
            const alertIcon = alertStatusCard.querySelector('.alert-icon');
            const alertText = alertStatusCard.querySelector('.alert-text');
            const enableBtn = document.getElementById('enableAlertBtn');
            
            const bookingAlerts = JSON.parse(localStorage.getItem('bookingAlerts') || '[]');
            const currentAlert = bookingAlerts.find(alert => alert.itemId === String(currentItemId));
            
            if (currentAlert) {
                alertIcon.textContent = 'üîî';
                alertText.textContent = `Alerts enabled for this item`;
                enableBtn.textContent = 'Disable Alerts';
                enableBtn.style.background = '#f44336';
                alertStatusCard.style.background = '#e8f5e8';
                alertStatusCard.style.borderColor = '#4CAF50';
            } else {
                alertIcon.textContent = 'üîï';
                alertText.textContent = 'No alerts set for this item';
                enableBtn.textContent = 'Enable Alerts';
                enableBtn.style.background = '#4CAF50';
                alertStatusCard.style.background = '#fff3e0';
                alertStatusCard.style.borderColor = '#FF9800';
            }
        }
        
        function enableCurrentItemAlert() {
            const bookingAlerts = JSON.parse(localStorage.getItem('bookingAlerts') || '[]');
            const existingAlert = bookingAlerts.find(alert => alert.itemId === String(currentItemId));
            
            if (existingAlert) {
                // Disable alert
                if (confirm('Are you sure you want to disable booking alerts for this item?')) {
                    const updatedAlerts = bookingAlerts.filter(alert => alert.itemId !== String(currentItemId));
                    localStorage.setItem('bookingAlerts', JSON.stringify(updatedAlerts));
                    
                    updateCurrentItemAlertStatus();
                    loadAllBookingAlerts();
                }
            } else {
                // Enable alert
                const userEmail = getUserEmail();
                if (!userEmail) {
                    const email = prompt('Please enter your email address for booking alerts:');
                    if (!email || !email.includes('@')) {
                        alert('Valid email address required for booking alerts.');
                        return;
                    }
                    localStorage.setItem('userEmail', email);
                }
                
                const currentProduct = getCurrentProduct();
                const alertData = {
                    itemId: String(currentItemId),
                    itemName: currentProduct.name,
                    enabled: true,
                    dateCreated: new Date().toISOString(),
                    emailSent: false
                };
                
                bookingAlerts.push(alertData);
                localStorage.setItem('bookingAlerts', JSON.stringify(bookingAlerts));
                
                updateCurrentItemAlertStatus();
                loadAllBookingAlerts();
                addRecentNotification(`Alerts enabled for ${currentProduct.name}`, 'Alert Setup');
            }
        }
        
        function loadAllBookingAlerts() {
            const container = document.getElementById('allAlertsContainer');
            if (!container) return;
            
            const noAlertsMessage = document.getElementById('noAlertsMessage');
            const bookingAlerts = JSON.parse(localStorage.getItem('bookingAlerts') || '[]');
            
            // Clear existing alerts
            const existingAlerts = container.querySelectorAll('.alert-item');
            existingAlerts.forEach(alert => alert.remove());
            
            if (bookingAlerts.length === 0) {
                if (noAlertsMessage) noAlertsMessage.style.display = 'block';
                return;
            }
            
            if (noAlertsMessage) noAlertsMessage.style.display = 'none';
            
            bookingAlerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert-item';
                alertDiv.innerHTML = `
                    <div class="alert-header">
                        <span class="alert-name">üì¶ ${alert.itemName}</span>
                        <span class="alert-status">üîî Active</span>
                    </div>
                    <div class="alert-details">
                        <small>Since ${new Date(alert.dateCreated).toLocaleDateString()}</small>
                    </div>
                `;
                
                if (alert.itemId === String(currentItemId)) {
                    alertDiv.style.background = '#e8f5e8';
                    alertDiv.style.borderColor = '#4CAF50';
                }
                
                container.appendChild(alertDiv);
            });
        }
        
        function loadRecentNotifications() {
            const container = document.getElementById('recentNotificationsContainer');
            if (!container) return;
            
            const noNotificationsMessage = document.getElementById('noNotificationsMessage');
            const recentNotifications = JSON.parse(localStorage.getItem('recentNotifications') || '[]');
            
            // Clear existing notifications
            const existingNotifications = container.querySelectorAll('.notification-item');
            existingNotifications.forEach(notification => notification.remove());
            
            if (recentNotifications.length === 0) {
                if (noNotificationsMessage) noNotificationsMessage.style.display = 'block';
                return;
            }
            
            if (noNotificationsMessage) noNotificationsMessage.style.display = 'none';
            
            // Show only last 3 notifications in chat panel
            const recentThree = recentNotifications.slice(0, 3);
            
            recentThree.forEach(notification => {
                const notificationDiv = document.createElement('div');
                notificationDiv.className = 'notification-item';
                notificationDiv.innerHTML = `
                    <div class="notification-header">
                        <span class="notification-type">${notification.type}</span>
                        <span class="notification-time">${notification.timestamp}</span>
                    </div>
                    <div class="notification-message">${notification.message}</div>
                `;
                container.appendChild(notificationDiv);
            });
        }
        
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (!badge) return;
            
            const bookingAlerts = JSON.parse(localStorage.getItem('bookingAlerts') || '[]');
            const recentNotifications = JSON.parse(localStorage.getItem('recentNotifications') || '[]');
            
            const unreadCount = recentNotifications.filter(n => !n.read).length;
            const alertCount = bookingAlerts.length;
            
            const totalCount = unreadCount + alertCount;
            
            if (totalCount > 0) {
                badge.textContent = totalCount;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }
        
        function addRecentNotification(message, type) {
            const recentNotifications = JSON.parse(localStorage.getItem('recentNotifications') || '[]');
            const notification = {
                message: message,
                type: type,
                timestamp: new Date().toLocaleTimeString(),
                id: Date.now(),
                read: false
            };
            
            recentNotifications.unshift(notification);
            
            // Keep only last 10 notifications
            if (recentNotifications.length > 10) {
                recentNotifications.splice(10);
            }
            
            localStorage.setItem('recentNotifications', JSON.stringify(recentNotifications));
            
            if (notificationPanelOpen) {
                loadRecentNotifications();
            }
            updateNotificationBadge();
        }
        
        function getUserEmail() {
            return localStorage.getItem('userEmail') || '';
        }
        
        function getCurrentProduct() {
            return sampleProducts.find(p => p.id === currentItemId) || { name: 'Unknown Item' };
        }
        
        function openRemindersPage() {
            window.location.href = `/reminder?item_id=${currentItemId}&item_name=${encodeURIComponent(getCurrentProduct().name)}&action=manage_all`;
        }
        
        function loadCurrentUser() {
            // Get current user from session
            fetch('/api/current_user')
                .then(response => response.json())
                .then(data => {
                    const userNameElement = document.getElementById('currentUserName');
                    if (userNameElement && data.user) {
                        userNameElement.textContent = data.user;
                        userNameElement.style.color = '#007BFF';
                    }
                })
                .catch(error => {
                    console.error('Error loading user:', error);
                    const userNameElement = document.getElementById('currentUserName');
                    if (userNameElement) {
                        userNameElement.textContent = '';
                    }
                });
            
            // Load seller information
            loadSellerInfo();
        }
        
        function loadSellerInfo() {
            // Dynamic seller names based on item ID
            const sellers = {
                '0': 'Alex Thompson',
                '1': 'Sarah Johnson', 
                '2': 'Mike Chen',
                '3': 'Emily Davis',
                '4': 'David Wilson',
                '5': 'Lisa Garcia'
            };
            
            const sellerName = sellers[currentItemId] || 'Seller';
            const sellerNameElement = document.getElementById('sellerNameHeader');
            
            if (sellerNameElement) {
                sellerNameElement.textContent = sellerName;
            }
        }
        
        function showSellerProfile() {
            const sellerName = document.getElementById('sellerNameHeader').textContent;
            
            // Create seller profile info based on seller name
            const sellerProfiles = {
                'Alex Thompson': {
                    bio: 'Experienced tech enthusiast with 5+ years selling electronics. All items thoroughly tested.',
                    location: 'Downtown Campus',
                    joinDate: 'Member since 2020',
                    specialties: ['Electronics', 'Gadgets', 'Smart Devices']
                },
                'Sarah Johnson': {
                    bio: 'Fashion-forward student selling quality clothing and accessories. Great condition guaranteed.',
                    location: 'University District',
                    joinDate: 'Member since 2021',
                    specialties: ['Fashion', 'Clothing', 'Accessories']
                },
                'Mike Chen': {
                    bio: 'Reliable seller specializing in everyday essentials and clothing. Fast pickup coordination.',
                    location: 'Central Campus',
                    joinDate: 'Member since 2019',
                    specialties: ['Clothing', 'Essentials', 'Daily Items']
                },
                'Emily Davis': {
                    bio: 'Detail-oriented seller with a focus on quality items. Professional and responsive.',
                    location: 'East Campus',
                    joinDate: 'Member since 2022',
                    specialties: ['General Items', 'Books', 'Supplies']
                },
                'David Wilson': {
                    bio: 'Tech professional selling premium electronics and accessories. Excellent condition items.',
                    location: 'Tech District',
                    joinDate: 'Member since 2018',
                    specialties: ['Electronics', 'Mobile Devices', 'Computers']
                },
                'Lisa Garcia': {
                    bio: 'Fashion enthusiast with great taste in shoes and accessories. Authentic items only.',
                    location: 'Fashion District',
                    joinDate: 'Member since 2021',
                    specialties: ['Shoes', 'Fashion', 'Style Accessories']
                }
            };
            
            const profile = sellerProfiles[sellerName] || {
                bio: 'Reliable marketplace seller committed to quality items and excellent service.',
                location: 'Local Area',
                joinDate: 'Member since 2020',
                specialties: ['Various Items']
            };
            
            alert(`üë®‚Äçüíº ${sellerName} - Seller Profile\\n\\n` +
                  `üìç Location: ${profile.location}\\n` +
                  `üìÖ ${profile.joinDate}\\n` +
                  `üè∑Ô∏è Specializes in: ${profile.specialties.join(', ')}\\n\\n` +
                  `‚ÑπÔ∏è About: ${profile.bio}\\n\\n` +
                  `‚≠ê Rating: 4.8/5 (24 reviews)\\n` +
                  `‚úÖ Verified Seller ‚Ä¢ üü¢ Online Now`);
        }

        // Chat functionality
        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');

        // Auto-scroll to bottom
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Add message to chat
        function addMessage(content, isUser = true, timestamp = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'seller-message'}`;
            
            const currentTime = timestamp || new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="message-bubble">
                        <p>${content}</p>
                        <span class="message-time">${currentTime}</span>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // Handle form submission
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            if (message) {
                // Add user message immediately
                addMessage(message, true);
                const userMessage = message;
                messageInput.value = '';
                
                // Save message to localStorage
                saveMessageToStorage(userMessage, true);
                
                // Show sending indicator briefly
                const sendingIndicator = addTypingIndicator('Sending...');
                
                // Simulate network delay and remove sending indicator
                setTimeout(() => {
                    if (sendingIndicator) sendingIndicator.remove();
                }, 500);
                
                // Simulate seller response with varied timing
                setTimeout(() => {
                    let randomResponse;
                    
                    // Check if message contains booking-related keywords
                    if (userMessage.toLowerCase().includes('book') || userMessage.toLowerCase().includes('pickup') || userMessage.toLowerCase().includes('schedule')) {
                        const bookingResponses = [
                            "Great! I'm available for pickup. When works best for you? I'm free Mon-Sat 9AM-7PM.",
                            "Perfect! Let's schedule your pickup. I can meet today after 2PM or tomorrow morning. What's your preference?",
                            "Excellent! For pickup, I'm available weekdays after 5PM and weekends anytime. What day works for you?",
                            "Sure thing! I can arrange pickup. My location is near downtown. When would you like to collect it?",
                            "Absolutely! I'm flexible with pickup times. Are you available this weekend? I can meet at a convenient location.",
                            "Of course! Let's book your pickup. I prefer daytime meetings for safety. How about tomorrow at 11AM?"
                        ];
                        randomResponse = bookingResponses[Math.floor(Math.random() * bookingResponses.length)];
                    } else if (userMessage.toLowerCase().includes('available') || userMessage.toLowerCase().includes('still')) {
                        const availabilityResponses = [
                            "Yes, it's still available! Would you like to arrange a pickup time?",
                            "Absolutely! The item is ready for pickup. When would you like to schedule?",
                            "Yes, still available! I can arrange pickup as early as today if you're interested.",
                            "It's yours if you want it! When would be a good time for pickup?",
                            "Still available! Several people have asked, so let me know if you'd like to book pickup soon."
                        ];
                        randomResponse = availabilityResponses[Math.floor(Math.random() * availabilityResponses.length)];
                    } else if (userMessage.toLowerCase().includes('location') || userMessage.toLowerCase().includes('where')) {
                        const locationResponses = [
                            "I'm located near [Location]. We can meet at the shopping center or I can provide my exact address once we confirm the pickup time.",
                            "I'm in the downtown area. Would you prefer to meet at a public place like the library or coffee shop?",
                            "My location is [Area]. I usually meet at the local mall for safety. Does that work for you?",
                            "I'm near [Landmark]. We can arrange a safe meeting spot once you're ready to pickup."
                        ];
                        randomResponse = locationResponses[Math.floor(Math.random() * locationResponses.length)];
                    } else if (userMessage.toLowerCase().includes('price') || userMessage.toLowerCase().includes('negotiate')) {
                        const priceResponses = [
                            "The listed price is fair, but I'm open to reasonable offers. What did you have in mind?",
                            "Price is negotiable! Make me an offer and we can discuss during pickup.",
                            "I'm flexible on price for serious buyers. What's your budget?",
                            "For quick pickup, I might consider a small discount. What's your offer?"
                        ];
                        randomResponse = priceResponses[Math.floor(Math.random() * priceResponses.length)];
                    } else {
                        const generalResponses = [
                            "Thanks for your interest! This item is in great condition.",
                            "Yes, it's still available. Would you like more details?",
                            "I can provide more photos if you'd like to see them.",
                            "Feel free to ask any questions about the item!",
                            "I can arrange a meeting for you to see it in person.",
                            "This is one of my best items. Very well maintained!",
                            "Let me know if you need any additional information.",
                            "I'm available to meet this week if you're interested.",
                            "Would you like to know more about its features?",
                            "The item is exactly as shown in the photos."
                        ];
                        randomResponse = generalResponses[Math.floor(Math.random() * generalResponses.length)];
                    }
                    
                    addMessage(randomResponse, false);
                    
                    // Save seller response to localStorage
                    saveMessageToStorage(randomResponse, false);
                }, 1500 + Math.random() * 2500);
            }
        });

        // Save message to localStorage
        function getChatKey() {
            return `chat_messages_user_${currentUser}_item_${currentProduct.id}`;
        }

        function saveMessageToStorage(message, isUser) {
            const chatKey = getChatKey();
            let messages = JSON.parse(localStorage.getItem(chatKey) || '[]');
            
            const messageObj = {
                content: message,
                isUser: isUser,
                timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                id: Date.now() + Math.random()
            };
            
            messages.push(messageObj);
            localStorage.setItem(chatKey, JSON.stringify(messages));
        }

        // Load messages from localStorage
        function loadMessagesFromStorage() {
            const chatKey = getChatKey();
            const messages = JSON.parse(localStorage.getItem(chatKey) || '[]');
            
            // If no messages exist, add welcome message
            if (messages.length === 0) {
                const welcomeMessage = {
                    content: `Hi! Thanks for your interest in ${currentProduct.name}. How can I help you?`,
                    isUser: false,
                    timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    id: Date.now()
                };
                messages.push(welcomeMessage);
                localStorage.setItem(chatKey, JSON.stringify(messages));
            }
            
            // Load messages into chat
            messages.forEach(msg => {
                addMessage(msg.content, msg.isUser, msg.timestamp);
            });
        }

        // Add typing indicator function
        function addTypingIndicator(text) {
            const indicatorDiv = document.createElement('div');
            indicatorDiv.className = 'message seller-message typing-indicator';
            indicatorDiv.innerHTML = `
                <div class="message-avatar">‚è≥</div>
                <div class="message-content">
                    <div class="message-bubble">
                        <p>${text}</p>
                    </div>
                </div>
            `;
            chatMessages.appendChild(indicatorDiv);
            scrollToBottom();
            return indicatorDiv;
        }

        // Clear chat function (for demo purposes)
        function clearChat() {
            const chatKey = getChatKey();
            localStorage.removeItem(chatKey);
            chatMessages.innerHTML = '';
            loadMessagesFromStorage();
        }

        // Add keyboard shortcut for clearing chat (Ctrl + K)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                if (confirm('Clear all messages?')) {
                    clearChat();
                }
            }
        });

        // Typing indicator functionality
        let typingTimeout;
        let isTyping = false;
        let typingIndicator = null;

        messageInput.addEventListener('input', function() {
            if (!isTyping) {
                isTyping = true;
                typingIndicator = addTypingIndicator('You are typing...');
            }
            
            clearTimeout(typingTimeout);
            
            typingTimeout = setTimeout(() => {
                if (typingIndicator) {
                    typingIndicator.remove();
                    typingIndicator = null;
                }
                isTyping = false;
            }, 1000);
        });

        // Enter key support for sending messages
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });

        // Initialize the chat
        document.addEventListener('DOMContentLoaded', function() {
            // Get item ID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const itemId = urlParams.get('item_id');
            
            if (itemId) {
                currentItemId = parseInt(itemId);
                localStorage.setItem('currentItemId', currentItemId);
            } else {
                // Try to get from localStorage if available
                const savedItemId = localStorage.getItem('currentItemId');
                if (savedItemId) {
                    currentItemId = parseInt(savedItemId);
                } else {
                    // Default to first product if no ID specified
                    currentItemId = 0;
                }
            }
            
            // Load product information first
            currentProduct = loadProductInfo();
            
            // Initialize notification system
            updateNotificationBadge();
            
            // Load current user information
            loadCurrentUser();
            
            // Auto-focus input
            messageInput.focus();
            
            // Load existing messages from localStorage
            loadMessagesFromStorage();
            
            // Initial scroll to bottom
            scrollToBottom();
        });

        // Booking Quick Action Functions
        function quickBooking() {
            const bookingMessage = "Hi! I'd like to book a pickup time for this item. When are you available?";
            messageInput.value = bookingMessage;
            messageInput.focus();
        }

        function checkAvailability() {
            const availabilityMessage = "Is this item still available? What pickup times work for you?";
            messageInput.value = availabilityMessage;
            messageInput.focus();
        }

        function askLocation() {
            const locationMessage = "Could you please share the pickup location or suggest a safe meeting place?";
            messageInput.value = locationMessage;
            messageInput.focus();
        }
    </script>
</body>
</html>