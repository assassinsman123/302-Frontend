<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>Message Seller - {{ item.name }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!--Navbar-->
    <nav class="navbar">
        <div class="nav-left">
            <h2>{{ item.name }}</h2>
        </div>
        
        <div class="nav-right">
            <!-- User Icon - Logout -->
            <div class="user-icon-container">
                <span class="user-icon" onclick="toggleLogout()" title="Click to show logout option">üë§</span>
                <span class="logout-text" id="logoutText" onclick="logout()" style="display: none;">Logout</span>
            </div>
        </div>
    </nav>

    <!--Item Message Container-->
    <div class="item-message-container">
        <!--Item Details-->
        <div class="item-details">
            <div class="item-image">
                <img src="{{ url_for('static', filename=item.image) }}" alt="{{ item.name }}">
            </div>
            
            <div class="seller-info">
                <div class="seller-details">
                    <h4>üë§ Seller Information</h4>
                    <div class="seller-card clickable-seller-card" onclick="showSellerProfile()" title="Click to view seller profile and reviews">
                        <div class="seller-avatar">
                            <span class="seller-icon">üë®‚Äçüíº</span>
                        </div>
                        <div class="seller-data">
                            <h5 class="seller-name" id="sellerNameDisplay">Product Owner</h5>
                            <div class="seller-status">
                                <span class="online-indicator">‚óè</span>
                                <span class="status-text">Online Now</span>
                            </div>
                            <div class="seller-rating">
                                <span class="rating-stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                                <span class="rating-text">(4.8/5 - 24 reviews)</span>
                            </div>
                            <div class="view-profile-hint">
                                <span class="hint-icon">üëÅÔ∏è</span>
                                <span class="hint-text">Click to view profile & reviews</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="item-info">
                <h1>{{ item.name }}</h1>
                <p class="item-price">${{ item.price }}</p>
                
                <!-- Detailed Product Information -->
                <div class="product-details-section">
                    <h3>üìã Product Details</h3>
                    
                    {% if item.get('category') %}
                        <div class="detail-item">
                            <strong>üè∑Ô∏è Category:</strong> 
                            <span class="detail-value">{{ item.category }}</span>
                        </div>
                    {% endif %}
                    
                    {% if item.get('condition') %}
                        <div class="detail-item">
                            <strong>‚úÖ Condition:</strong> 
                            <span class="detail-value condition-{{ item.condition.lower().replace(' ', '-') }}">
                                {{ item.condition }}
                                {% if item.condition.lower() == 'excellent' %}
                                    - Like new, minimal signs of use
                                {% elif item.condition.lower() == 'good' %}
                                    - Well maintained, minor wear only
                                {% elif item.condition.lower() == 'fair' %}
                                    - Functional with visible wear
                                {% elif item.condition.lower() == 'new' %}
                                    - Brand new, unused condition
                                {% elif item.condition.lower() == 'used' %}
                                    - Previously owned, good working order
                                {% endif %}
                            </span>
                        </div>
                    {% else %}
                        <div class="detail-item">
                            <strong>‚úÖ Condition:</strong> 
                            <span class="detail-value condition-excellent">Excellent - Like new, minimal signs of use</span>
                        </div>
                    {% endif %}
                    
                    {% if item.get('features') %}
                        <div class="detail-item">
                            <strong>üîß Features:</strong>
                            <div class="detail-value">{{ item.features }}</div>
                        </div>
                    {% else %}
                        <div class="detail-item">
                            <strong>üîß Features:</strong>
                            <div class="detail-value">
                                {% set item_category = item.get('category', '').lower() %}
                                {% set item_name = item.get('name', '').lower() %}
                                {% if 'electronics' in item_category or 'phone' in item_name or 'laptop' in item_name or 'watch' in item_name %}
                                    ‚Ä¢ Latest technology and specifications<br>
                                    ‚Ä¢ Excellent performance and reliability<br>
                                    ‚Ä¢ All original accessories included<br>
                                    ‚Ä¢ Warranty coverage available
                                {% elif 'clothing' in item_category or 'shirt' in item_name or 'pants' in item_name %}
                                    ‚Ä¢ Premium quality fabric<br>
                                    ‚Ä¢ Comfortable fit and design<br>
                                    ‚Ä¢ Machine washable<br>
                                    ‚Ä¢ Versatile styling options
                                {% elif 'fashion' in item_category or 'shoes' in item_name %}
                                    ‚Ä¢ Stylish and trendy design<br>
                                    ‚Ä¢ Comfortable for daily wear<br>
                                    ‚Ä¢ Durable construction<br>
                                    ‚Ä¢ Available in popular sizes
                                {% else %}
                                    ‚Ä¢ High quality construction<br>
                                    ‚Ä¢ Durable materials<br>
                                    ‚Ä¢ Great value for money<br>
                                    ‚Ä¢ Ready for immediate use
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                    
                    <div class="detail-item">
                        <strong>üíé Benefits:</strong>
                        <div class="detail-value">
                            {% set item_category = item.get('category', '').lower() %}
                            {% set item_name = item.get('name', '').lower() %}
                            {% if 'electronics' in item_category or 'phone' in item_name or 'laptop' in item_name or 'watch' in item_name %}
                                ‚Ä¢ Excellent value compared to retail price<br>
                                ‚Ä¢ Thoroughly tested and verified working<br>
                                ‚Ä¢ Safe pickup with item demonstration<br>
                                ‚Ä¢ Chat to schedule convenient pickup time
                            {% elif 'clothing' in item_category or 'shirt' in item_name or 'pants' in item_name %}
                                ‚Ä¢ Significant savings on designer clothing<br>
                                ‚Ä¢ Pre-washed and ready to wear<br>
                                ‚Ä¢ Flexible pickup times for your convenience<br>
                                ‚Ä¢ Try before you buy option available
                            {% elif 'fashion' in item_category or 'shoes' in item_name %}
                                ‚Ä¢ Authentic brand at reduced price<br>
                                ‚Ä¢ Carefully maintained condition<br>
                                ‚Ä¢ Easy pickup coordination via chat<br>
                                ‚Ä¢ Perfect for style-conscious buyers
                            {% else %}
                                ‚Ä¢ Excellent value for the price<br>
                                ‚Ä¢ Flexible pickup times available<br>
                                ‚Ä¢ Safe and convenient pickup location<br>
                                ‚Ä¢ Chat to book your preferred time slot
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <strong>üí∞ Price Information:</strong>
                        <div class="detail-value">
                            <div class="price-breakdown">
                                <span class="current-price">${{ item.price }}</span>
                                <span class="price-note">üí° Best offer accepted</span>
                            </div>
                            <small class="price-details">‚Ä¢ No hidden fees ‚Ä¢ Cash or digital payment ‚Ä¢ Free pickup</small>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <strong>üì¶ Item Status & Pickup:</strong>
                        <div class="detail-value">
                            <span class="status-available">‚úÖ Available for Pickup</span>
                            {% set item_category = item.get('category', '').lower() %}
                            {% set item_name = item.get('name', '').lower() %}
                            {% if 'electronics' in item_category or 'phone' in item_name or 'laptop' in item_name or 'watch' in item_name %}
                                <br><small>Pickup available: Mon-Sat 10AM-8PM (Electronics testing time included)</small>
                                <br><small>Bring charger if available for testing</small>
                            {% elif 'clothing' in item_category or 'shirt' in item_name or 'pants' in item_name %}
                                <br><small>Pickup available: Daily 9AM-7PM (Try-on time available)</small>
                                <br><small>Size exchange possible if discussed beforehand</small>
                            {% elif 'fashion' in item_category or 'shoes' in item_name %}
                                <br><small>Pickup available: Mon-Sat 9AM-7PM (Fitting time available)</small>
                                <br><small>Bring socks for shoe fitting if needed</small>
                            {% else %}
                                <br><small>Pickup available: Mon-Sat 9AM-7PM</small>
                                <br><small>Location will be shared after booking confirmation</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--Message Box-->
        <div class="message-box">
            <h2>ÔøΩ Contact Seller</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                üí¨ Start a conversation with the seller to discuss details and arrange pickup
            </p>
            <form action="{{ url_for('message_seller', item_id=item_id) }}" method="POST">
                <textarea name="message" placeholder="Hi! I'm interested in this item. Is it still available? When would be a good time to arrange pickup?" rows="4" required></textarea>
                <div class="message-actions">
                    <div class="spacer"></div>
                    <!--Action Icons-->
                    <div class="action-icons">
                        <span title="Setup Booking Alerts" onclick="toggleBookingAlerts('{{ item_id }}', '{{ item.name }}')" id="notificationIcon" style="cursor: pointer;">üîî</span>
                        <span class="save-btn" title="{% if is_in_wishlist %}Remove from Wishlist{% else %}Add to Wishlist{% endif %}" onclick="toggleWishlist('{{ item_id }}')" id="wishlistIcon">
                            {% if is_in_wishlist %}‚òÖ{% else %}‚òÜ{% endif %}
                        </span>
                    </div>
                    <div class="button-group">
                        <button type="button" onclick="window.location.href='{{ url_for('products') }}'" class="btn-secondary">Cancel</button>
                        <button type="button" onclick="window.location.href='{{ url_for('chat_with_seller', item_id=item_id) }}'" class="btn-chat">üí¨ Chat Now</button>
                        <button type="submit" class="btn-primary">ÔøΩ Send Message</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Pop-up Notification -->
    <div id="notification-popup" class="notification-popup">
        <div class="notification-content">
            <span class="notification-icon" id="notificationEmoji">‚≠ê</span>
            <span class="notification-text">Item saved to wishlist!</span>
            <span class="close-notification" onclick="closeNotification()">‚úï</span>
        </div>
    </div>

    <script>
        function toggleLogout() {
            const logoutText = document.getElementById('logoutText');
            const isVisible = logoutText.style.display !== 'none';
            
            if (isVisible) {
                logoutText.style.display = 'none';
            } else {
                logoutText.style.display = 'inline-block';
            }
        }
        
        function logout() {
            window.location.href = "{{ url_for('logout') }}";
        }
        
        function toggleBookingAlerts(itemId, itemName) {
            // Instead of showing a prompt, redirect to the reminder page with item info
            const params = new URLSearchParams({
                item_id: itemId,
                item_name: itemName,
                action: 'enable_alert'
            });
            
            window.location.href = `{{ url_for('reminder') }}?${params.toString()}`;
        }
        
        function checkExistingBookingAlerts() {
            const itemId = '{{ item_id }}';
            const bookingAlerts = JSON.parse(localStorage.getItem('bookingAlerts') || '[]');
            const existingAlert = bookingAlerts.find(alert => alert.itemId === itemId);
            
            if (existingAlert && existingAlert.enabled) {
                const icon = document.getElementById('notificationIcon');
                icon.classList.add('alert-enabled');
                icon.style.color = '#FF6B35';
                icon.style.animation = 'pulse 1s infinite';
                icon.title = 'Booking alerts enabled - Click to manage';
            }
        }
        
        function toggleWishlist(itemId) {
            // Send AJAX request to toggle item in wishlist
            fetch(`/toggle_wishlist/${itemId}?ajax=1`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the icon and tooltip based on the new state
                    const wishlistIcon = document.getElementById('wishlistIcon');
                    const notificationText = document.querySelector('.notification-text');
                    const notificationEmoji = document.getElementById('notificationEmoji');
                    
                    if (data.is_in_wishlist) {
                        // Item was added to wishlist
                        wishlistIcon.innerHTML = '‚òÖ';
                        wishlistIcon.title = 'Remove from Wishlist';
                        notificationText.textContent = 'Item added to wishlist!';
                        notificationEmoji.textContent = '‚≠ê';
                    } else {
                        // Item was removed from wishlist
                        wishlistIcon.innerHTML = '‚òÜ';
                        wishlistIcon.title = 'Add to Wishlist';
                        notificationText.textContent = 'Item removed from wishlist!';
                        notificationEmoji.textContent = 'üóëÔ∏è';
                    }
                    
                    showNotification();
                } else {
                    alert(data.message || 'Failed to update wishlist');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating wishlist');
            });
        }
        
        function showNotification() {
            const popup = document.getElementById('notification-popup');
            const notificationText = document.querySelector('.notification-text');
            const notificationContent = document.querySelector('.notification-content');
            
            // Change color based on action
            if (notificationText.textContent.includes('removed')) {
                notificationContent.style.background = '#f44336'; // Red for removal
            } else {
                notificationContent.style.background = '#4CAF50'; // Green for addition
            }
            
            popup.style.display = 'flex';
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                closeNotification();
            }, 3000);
        }
        
        function closeNotification() {
            const popup = document.getElementById('notification-popup');
            popup.style.display = 'none';
        }

        // Add form submission feedback
        document.addEventListener('DOMContentLoaded', function() {
            // Clear any cached guest user data
            localStorage.removeItem('demo_user');
            const guestKeys = Object.keys(localStorage).filter(key => 
                key.includes('guest') || key.includes('Guest'));
            guestKeys.forEach(key => localStorage.removeItem(key));
            
            // Load seller information
            loadSellerInfo();
            
            const messageForm = document.querySelector('form[action*="message"]');
            const submitButton = document.querySelector('.btn-primary');
            
            if (messageForm && submitButton) {
                messageForm.addEventListener('submit', function(e) {
                    // Change button text to show loading state
                    submitButton.innerHTML = 'üì§ Sending...';
                    submitButton.disabled = true;
                    
                    // Show user feedback
                    const textarea = document.querySelector('textarea[name="message"]');
                    if (textarea && textarea.value.trim()) {
                        // Create a temporary notification
                        const tempNotification = document.createElement('div');
                        tempNotification.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: #007BFF;
                            color: white;
                            padding: 15px 20px;
                            border-radius: 8px;
                            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                            z-index: 1000;
                            font-size: 14px;
                            animation: slideIn 0.3s ease-out;
                        `;
                        tempNotification.innerHTML = 'ÔøΩ Starting conversation with seller...';
                        document.body.appendChild(tempNotification);
                        
                        // Remove notification after form submits
                        setTimeout(() => {
                            if (tempNotification.parentNode) {
                                tempNotification.remove();
                            }
                        }, 2000);
                    }
                });
            }
        });
        
        function loadCurrentUser() {
            // Get current user from session
            const currentUser = '{{ session.get("user", "") }}';
            const userNameElement = document.getElementById('currentUserName');
            
            if (userNameElement) {
                if (currentUser && currentUser.trim() !== '' && currentUser  && currentUser !== 'guest_user') {
                    userNameElement.textContent = currentUser;
                    userNameElement.style.color = '#007BFF';
                    userNameElement.style.display = 'inline';
                } else {
                    userNameElement.textContent = '';
                    userNameElement.style.display = 'none';
                }
            }
            
            // Load seller information
            loadSellerInfo();
        }
        
        function showSellerProfile() {
            const sellerName = document.getElementById('sellerNameDisplay').textContent;
            const itemId = '{{ item_id }}';
            
            // Navigate to review page with seller parameter
            window.location.href = `/review?seller=${encodeURIComponent(sellerName)}&item_id=${itemId}`;
        }
        
        function loadSellerInfo() {
            // Dynamic seller names based on item ID
            const itemId = '{{ item_id }}';
            const sellers = {
                '0': 'Alex Thompson',
                '1': 'Sarah Johnson', 
                '2': 'Mike Chen',
                '3': 'Emily Davis',
                '4': 'David Wilson',
                '5': 'Lisa Garcia'
            };
            
            const sellerName = sellers[itemId] || 'Product Owner';
            const sellerNameElement = document.getElementById('sellerNameDisplay');
            
            if (sellerNameElement) {
                sellerNameElement.textContent = sellerName;
            }
        }
    </script>
</body>
</html>




