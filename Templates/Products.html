<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marketplace</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-left">
      <h2>Marketplace</h2>
      <!-- Enhanced Search Bar -->
      <div class="search-container">
        <span class="search-icon">🔍</span>
        <input type="text" id="searchInput" placeholder="Search products, categories, features..." onkeyup="performSearch()">
        <span class="clear-search" id="clearSearch" onclick="clearSearch()" style="display: none;">✕</span>
      </div>
      <!-- Sell Button -->
      <a href="{{ url_for('upload') }}" class="btn">Sell</a>
      <!-- Dashboard Button -->
      <a href="{{ url_for('dashboard') }}" class="btn">Dashboard</a>
      <!-- Your Listings Button -->
      <a href="{{ url_for('your_listings') }}" class="btn">Your Listings</a>
      <!-- Categories Dropdown -->
      <div class="categories-dropdown" id="categoriesDropdown">
        <button class="btn active" id="categoriesBtn" onclick="toggleCategories()">Categories ▼</button>
        <div class="categories-menu" id="categoriesMenu">
          <div class="filter-section">
            <h4>Filter by Category</h4>
            <select id="categoryFilter">
              <option value="">All Categories</option>
              <option value="electronics">Electronics</option>
              <option value="clothing">Clothing</option>
              <option value="fashion">Fashion</option>
              <option value="books">Books</option>
              <option value="home">Home & Garden</option>
            </select>
          </div>
          
          <div class="filter-section">
            <h4>Condition</h4>
            <select id="conditionFilter">
              <option value="">All Conditions</option>
              <option value="new">New</option>
              <option value="excellent">Excellent</option>
              <option value="good">Good</option>
              <option value="used">Used</option>
              <option value="fair">Fair</option>
            </select>
          </div>
          
          <div class="filter-section">
            <h4>Price Range</h4>
            <div class="price-inputs">
              <input type="number" id="minPrice" placeholder="Min $">
              <span>-</span>
              <input type="number" id="maxPrice" placeholder="Max $">
            </div>
          </div>
          
          <div class="filter-actions">
            <button onclick="applyFilters()" class="apply-filters-btn">Apply Filters</button>
            <button onclick="clearFilters()" class="clear-filters-btn">Clear Filters</button>
            <button onclick="closeCategories()" class="close-menu-btn">Close</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="nav-right">
      <!-- Wishlist Icon -->
      <a href="{{ url_for('wishlist') }}" class="wishlist-icon" title="View Wishlist">❤️</a>
      <!-- Customer Support Icon -->
      <a href="{{ url_for('customer_support') }}" class="support-icon" title="Customer Support">🆘</a>
      <!-- User Icon - Dropdown -->
      <div class="user-dropdown" id="userDropdown">
        <span class="user-icon" onclick="toggleUserMenu()" title="User Menu">👤</span>
        <div class="user-menu" id="userMenu">
          <div class="user-menu-header">
            <span class="user-avatar">👤</span>
            <div class="user-info">
              <span class="user-name">User</span>
              <span class="user-status">Online</span>
            </div>
          </div>
          <div class="menu-divider"></div>
          <div class="menu-actions">
            <a href="{{ url_for('dashboard') }}" class="menu-item">
              <span class="menu-icon">📊</span>
              <span>Dashboard</span>
            </a>
            <a href="{{ url_for('your_listings') }}" class="menu-item">
              <span class="menu-icon">📦</span>
              <span>Your Listings</span>
            </a>
            <button onclick="logout()" class="menu-item logout-item">
              <span class="menu-icon">🚪</span>
              <span>Logout</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </nav>
  

  
  <!-- Search Results Info -->
  <div class="search-results-info" id="searchInfo" style="display: none;"></div>
  
  <!-- Loading Spinner -->
  <div class="loading-spinner" id="loadingSpinner">🔄 Searching...</div>
  
  <!-- Products Grid -->
  <div class="products" id="productsContainer">
    {% for product in products %}
    <div class="product" data-name="{{ product.name.lower() }}" data-category="{{ product.category.lower() }}" data-price="{{ product.price }}" data-features="{{ product.features.lower() }}" data-condition="{{ product.condition.lower() if product.condition else 'good' }}">
      <a href="{{ url_for('message_seller', item_id=loop.index0) }}" class="product-image-link">
        <img src="{{ url_for('static', filename=product.image) }}" alt="{{ product.name }}">
      </a>
      <div class="product-info">
        <p class="product-name">{{ product.name }}</p>
        <p class="product-price">${{ product.price }}</p>
      </div>
    </div>
    {% endfor %}
  </div>
  
  <!-- No Results Message -->
  <div class="no-results" id="noResults" style="display: none;">
    <div class="no-results-icon">🔍</div>
    <h3>No products found</h3>
    <p>Try adjusting your search terms or filters</p>
    <button onclick="clearSearch()" class="clear-search-btn">Clear Search</button>
  </div>

  <script>
    let searchTimeout;
    let allProducts = [];
    
    // Store original products on page load
    document.addEventListener('DOMContentLoaded', function() {
      const productElements = document.querySelectorAll('.product');
      allProducts = Array.from(productElements).map((element, index) => ({
        element: element,
        name: element.dataset.name,
        category: element.dataset.category,
        price: parseFloat(element.dataset.price),
        features: element.dataset.features,
        condition: element.dataset.condition || 'good',
        index: index
      }));
    });
    
    function toggleUserMenu() {
      const userMenu = document.getElementById('userMenu');
      const userIcon = document.querySelector('.user-icon');
      
      userMenu.classList.toggle('active');
      
      if (userMenu.classList.contains('active')) {
        userIcon.classList.add('active');
      } else {
        userIcon.classList.remove('active');
      }
    }
    
    function closeUserMenu() {
      const userMenu = document.getElementById('userMenu');
      const userIcon = document.querySelector('.user-icon');
      
      userMenu.classList.remove('active');
      userIcon.classList.remove('active');
    }
    
    function viewProfile() {
      // Add profile functionality here
      alert('Profile page coming soon!');
      closeUserMenu();
    }
    
    function viewSettings() {
      // Add settings functionality here
      alert('Settings page coming soon!');
      closeUserMenu();
    }
    
    function logout() {
      window.location.href = "{{ url_for('logout') }}";
    }
    
    function toggleCategories() {
      const categoriesMenu = document.getElementById('categoriesMenu');
      const categoriesBtn = document.getElementById('categoriesBtn');
      
      categoriesMenu.classList.toggle('active');
      
      if (categoriesMenu.classList.contains('active')) {
        categoriesBtn.textContent = 'Categories ▲';
        categoriesBtn.classList.add('filter-active');
      } else {
        categoriesBtn.textContent = 'Categories ▼';
        categoriesBtn.classList.remove('filter-active');
      }
    }
    
    function closeCategories() {
      const categoriesMenu = document.getElementById('categoriesMenu');
      const categoriesBtn = document.getElementById('categoriesBtn');
      
      categoriesMenu.classList.remove('active');
      categoriesBtn.textContent = 'Categories ▼';
      categoriesBtn.classList.remove('filter-active');
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
      const categoriesDropdown = document.getElementById('categoriesDropdown');
      const categoriesMenu = document.getElementById('categoriesMenu');
      const userDropdown = document.getElementById('userDropdown');
      const userMenu = document.getElementById('userMenu');
      
      // Close categories dropdown
      if (!categoriesDropdown.contains(event.target) && categoriesMenu.classList.contains('active')) {
        closeCategories();
      }
      
      // Close user dropdown
      if (!userDropdown.contains(event.target) && userMenu.classList.contains('active')) {
        closeUserMenu();
      }
    });
    
    function performSearch() {
      // Clear previous timeout
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }
      
      // Debounce search for better performance
      searchTimeout = setTimeout(() => {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
        const category = document.getElementById('categoryFilter').value.toLowerCase();
        const condition = document.getElementById('conditionFilter').value.toLowerCase();
        const minPrice = document.getElementById('minPrice').value;
        const maxPrice = document.getElementById('maxPrice').value;
        
        // Show/hide clear button
        const clearBtn = document.getElementById('clearSearch');
        clearBtn.style.display = searchTerm ? 'inline' : 'none';
        
        // Filter products
        let filteredProducts = allProducts.filter(product => {
          // Text search
          if (searchTerm) {
            const searchableText = `${product.name} ${product.category} ${product.features}`;
            if (!searchableText.includes(searchTerm)) {
              return false;
            }
          }
          
          // Category filter
          if (category && category !== product.category) {
            return false;
          }
          
          // Condition filter
          if (condition && condition !== product.condition) {
            return false;
          }
          
          // Price range filter
          if (minPrice && product.price < parseFloat(minPrice)) {
            return false;
          }
          if (maxPrice && product.price > parseFloat(maxPrice)) {
            return false;
          }
          
          return true;
        });
        
        // Update display
        updateProductDisplay(filteredProducts, searchTerm, category, condition, minPrice, maxPrice);
        
      }, 300); // 300ms delay for better UX
    }
    
    function updateProductDisplay(filteredProducts, searchTerm, category, condition, minPrice, maxPrice) {
      const container = document.getElementById('productsContainer');
      const noResults = document.getElementById('noResults');
      const searchInfo = document.getElementById('searchInfo');
      
      // Hide all products first
      allProducts.forEach(product => {
        product.element.style.display = 'none';
      });
      
      // Show filtered products
      filteredProducts.forEach(product => {
        product.element.style.display = 'flex';
      });
      
      // Update search info
      let searchInfoText = '';
      if (searchTerm || category || condition || minPrice || maxPrice) {
        const totalProducts = allProducts.length;
        const foundProducts = filteredProducts.length;
        
        searchInfoText = `Showing ${foundProducts} of ${totalProducts} products`;
        
        if (searchTerm) searchInfoText += ` for "${searchTerm}"`;
        if (category) searchInfoText += ` in ${category.charAt(0).toUpperCase() + category.slice(1)}`;
        if (condition) searchInfoText += ` (${condition.charAt(0).toUpperCase() + condition.slice(1)} condition)`;
        if (minPrice || maxPrice) {
          searchInfoText += ` ($${minPrice || '0'} - $${maxPrice || '∞'})`;
        }
        
        searchInfo.textContent = searchInfoText;
        searchInfo.style.display = 'block';
      } else {
        searchInfo.style.display = 'none';
      }
      
      // Show/hide no results message
      if (filteredProducts.length === 0 && (searchTerm || category || condition || minPrice || maxPrice)) {
        noResults.style.display = 'block';
        container.style.display = 'none';
      } else {
        noResults.style.display = 'none';
        container.style.display = 'grid';
      }
    }
    
    function clearSearch() {
      document.getElementById('searchInput').value = '';
      document.getElementById('categoryFilter').value = '';
      document.getElementById('conditionFilter').value = '';
      document.getElementById('minPrice').value = '';
      document.getElementById('maxPrice').value = '';
      document.getElementById('clearSearch').style.display = 'none';
      
      // Show all products
      allProducts.forEach(product => {
        product.element.style.display = 'flex';
      });
      
      // Hide search info and no results
      document.getElementById('searchInfo').style.display = 'none';
      document.getElementById('noResults').style.display = 'none';
      document.getElementById('productsContainer').style.display = 'grid';
    }
    
    function applyFilters() {
      performSearch();
      closeCategories();
    }
    
    function clearFilters() {
      document.getElementById('categoryFilter').value = '';
      document.getElementById('conditionFilter').value = '';
      document.getElementById('minPrice').value = '';
      document.getElementById('maxPrice').value = '';
      performSearch();
    }
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Focus search on Ctrl+F or Cmd+F
      if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        document.getElementById('searchInput').focus();
      }
      
      // Clear search on Escape
      if (e.key === 'Escape') {
        clearSearch();
      }
    });
    
    // Auto-focus search input
    document.getElementById('searchInput').addEventListener('focus', function() {
      this.select(); // Select all text when focused
    });
  </script>
</body>
</html>