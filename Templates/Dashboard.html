<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Dashboard - Marketplace</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-left">
      <h2>My Dashboard</h2>
      <a href="{{ url_for('products') }}" class="btn">Back to Marketplace</a>
    </div>
    
    <div class="nav-right">
      <!-- Wishlist Icon -->
      <a href="{{ url_for('wishlist') }}" class="wishlist-icon" title="View Wishlist">❤️</a>
      <!-- Customer Support Icon -->
      <a href="{{ url_for('customer_support') }}" class="support-icon" title="Customer Support">🆘</a>
      <!-- User Icon - Dropdown -->
      <div class="user-dropdown" id="userDropdown">
        <span class="user-icon" onclick="toggleUserMenu()" title="User Menu">👤</span>
        <div class="user-menu" id="userMenu">
          <div class="user-menu-header">
            <span class="user-avatar">👤</span>
            <div class="user-info">
              <span class="user-name">User</span>
              <span class="user-status">Online</span>
            </div>
          </div>
          <div class="menu-divider"></div>
          <div class="menu-actions">
            <button onclick="logout()" class="menu-item logout-item">
              <span class="menu-icon">🚪</span>
              <span>Logout</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Dashboard Container -->
  <div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <h1>📊 My Dashboard</h1>
      <p>Track your uploads, purchases, and marketplace activity</p>
    </div>

    <!-- Quick Stats -->
    <div class="dashboard-stats">
      <div class="stat-card">
        <div class="stat-icon">📤</div>
        <div class="stat-info">
          <h3 id="uploadCount">0</h3>
          <p>Items Uploaded</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">💬</div>
        <div class="stat-info">
          <h3 id="messagesCount">0</h3>
          <p>Messages</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">❤️</div>
        <div class="stat-info">
          <h3 id="wishlistCount">0</h3>
          <p>Wishlist Items</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">🔔</div>
        <div class="stat-info">
          <h3 id="alertsCount">0</h3>
          <p>Active Alerts</p>
        </div>
      </div>
    </div>

    <!-- Main Dashboard Sections -->
    <div class="dashboard-sections">
      <!-- Upload Section -->
      <div class="dashboard-section">
        <div class="section-header">
          <h2>📤 My Uploads</h2>
          <a href="{{ url_for('upload') }}" class="btn-add">+ Add New</a>
        </div>
        
        <div id="uploadsList" class="items-grid">
          <!-- Uploaded items will be loaded here -->
          <div class="empty-state">
            <div class="empty-icon">📦</div>
            <h3>No Items Uploaded Yet</h3>
            <p>Start selling by uploading your first item</p>
            <a href="{{ url_for('upload') }}" class="btn-primary">Upload Item</a>
          </div>
        </div>
      </div>

      <!-- Messages Section -->
      <div class="dashboard-section">
        <div class="section-header">
          <h2>💬 Messages</h2>
          <span class="section-info">View all your conversations</span>
        </div>
        
        <div id="messagesSection" class="messages-section">
          <!-- Single clickable card to view all messages -->
          <div class="messages-overview-card" onclick="goToMessages()">
            <div class="messages-icon">💬</div>
            <div class="messages-info">
              <h3>View All Messages</h3>
              <p id="messagesDescription">Click to see your conversations with sellers</p>
              <div class="messages-stats">
                <span class="stat-badge">
                  <strong id="totalConversations">0</strong> Conversations
                </span>
                <span class="stat-badge">
                  <strong id="totalMessages">0</strong> Total Messages
                </span>
              </div>
            </div>
            <div class="arrow-icon">→</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Toggle user menu
    function toggleUserMenu() {
      const userMenu = document.getElementById('userMenu');
      const userIcon = document.querySelector('.user-icon');
      
      userMenu.classList.toggle('active');
      
      if (userMenu.classList.contains('active')) {
        userIcon.classList.add('active');
      } else {
        userIcon.classList.remove('active');
      }
    }

    // Close user menu when clicking outside
    document.addEventListener('click', function(event) {
      const userDropdown = document.getElementById('userDropdown');
      const userMenu = document.getElementById('userMenu');
      
      if (!userDropdown.contains(event.target) && userMenu.classList.contains('active')) {
        userMenu.classList.remove('active');
        document.querySelector('.user-icon').classList.remove('active');
      }
    });

    // Logout function
    function logout() {
      window.location.href = "{{ url_for('logout') }}";
    }

    // Get current user - Auto-create if needed
    function getCurrentUser() {
      let user = localStorage.getItem('current_user');
      if (!user) {
        // Auto-create a session instead of redirecting
        user = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('current_user', user);
        console.log('Auto-created user session:', user);
      }
      return user;
    }

    // Load user's uploaded items
    function loadUploadedItems() {
      const currentUser = getCurrentUser();
      if (!currentUser) return;

      const uploadsList = document.getElementById('uploadsList');
      const allProducts = {{ products|tojson|safe if products else '[]' }};
      
      // Filter products uploaded by current user (you'll need to track this in your backend)
      const userProducts = JSON.parse(localStorage.getItem(`user_uploads_${currentUser}`) || '[]');
      
      if (userProducts.length === 0) {
        return; // Keep empty state
      }

      uploadsList.innerHTML = '';
      
      userProducts.forEach(product => {
        const itemCard = createItemCard(product, 'upload');
        uploadsList.appendChild(itemCard);
      });

      // Update count
      document.getElementById('uploadCount').textContent = userProducts.length;
    }

    // Load messages summary
    function loadMessages() {
      const currentUser = getCurrentUser();
      if (!currentUser) return;

      // Get all chat messages from localStorage
      let totalConversations = 0;
      let totalMessages = 0;
      
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('chat_messages_')) {
          const messages = JSON.parse(localStorage.getItem(key) || '[]');
          if (messages.length > 0) {
            totalConversations++;
            totalMessages += messages.length;
          }
        }
      }
      
      // Update the overview card
      document.getElementById('totalConversations').textContent = totalConversations;
      document.getElementById('totalMessages').textContent = totalMessages;
      document.getElementById('messagesCount').textContent = totalConversations;
      
      // Update description based on whether there are messages
      const description = document.getElementById('messagesDescription');
      if (totalConversations > 0) {
        description.textContent = `You have ${totalConversations} active conversation${totalConversations > 1 ? 's' : ''}`;
      } else {
        description.textContent = 'No conversations yet. Start chatting with sellers!';
      }
    }

    // Go to messages page
    function goToMessages() {
      // Navigate to the messages page
      window.location.href = "{{ url_for('messages') }}";
    }

    // Create item card
    function createItemCard(item, type) {
      const card = document.createElement('div');
      card.className = 'dashboard-item-card';
      
      card.innerHTML = `
        <div class="item-image">
          <img src="${item.image || '/static/images/placeholder.jpg'}" alt="${item.name}">
          ${type === 'upload' ? '<span class="item-status active">Active</span>' : ''}
        </div>
        <div class="item-details">
          <h3>${item.name}</h3>
          <p class="item-price">$${item.price}</p>
          <p class="item-category">${item.category || 'Uncategorized'}</p>
          ${type === 'upload' ? `
            <div class="item-actions">
              <button onclick="viewItem(${item.item_id})" class="btn-view">View</button>
              <button onclick="editItem(${item.item_id})" class="btn-edit">Edit</button>
              <button onclick="deleteItem(${item.item_id})" class="btn-delete">Delete</button>
            </div>
          ` : ''}
        </div>
      `;
      
      return card;
    }

    // Item action functions
    function viewItem(itemId) {
      window.location.href = `/message/seller/${itemId}`;
    }

    function editItem(itemId) {
      alert('Edit functionality - redirect to edit page');
      // window.location.href = `/edit/${itemId}`;
    }

    function deleteItem(itemId) {
      if (confirm('Are you sure you want to delete this item?')) {
        const currentUser = getCurrentUser();
        let userProducts = JSON.parse(localStorage.getItem(`user_uploads_${currentUser}`) || '[]');
        userProducts = userProducts.filter(item => item.item_id !== itemId);
        localStorage.setItem(`user_uploads_${currentUser}`, JSON.stringify(userProducts));
        loadUploadedItems();
        showNotification('Item deleted successfully', 'success');
      }
    }

    // Update wishlist count
    function updateWishlistCount() {
      const currentUser = getCurrentUser();
      if (!currentUser) return;

      const wishlist = JSON.parse(localStorage.getItem(`wishlist_${currentUser}`) || '[]');
      document.getElementById('wishlistCount').textContent = wishlist.length;
    }

    // Update alerts count
    function updateAlertsCount() {
      const bookingAlerts = JSON.parse(localStorage.getItem('bookingAlerts') || '[]');
      document.getElementById('alertsCount').textContent = bookingAlerts.length;
    }

    // Show notification
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.textContent = message;
      
      notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: ${type === 'success' ? '#4CAF50' : type === 'warning' ? '#FF9800' : '#2196F3'};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Initialize dashboard on load
    window.addEventListener('DOMContentLoaded', function() {
      const currentUser = getCurrentUser();
      if (currentUser) {
        loadUploadedItems();
        loadMessages();
        updateWishlistCount();
        updateAlertsCount();
      }
    });

    // Add animation styles
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>